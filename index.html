<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Price Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0f1117;
      --surface:   #1a1d27;
      --surface2:  #22263a;
      --border:    #2e3347;
      --text:      #e8eaf0;
      --muted:     #7b82a0;
      --accent:    #4f8ef7;
      --green:     #34d98b;
      --red:       #f75c5c;
      --yellow:    #f7c948;
      --font-body: 'DM Sans', sans-serif;
      --font-mono: 'DM Mono', monospace;
      --radius:    12px;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-body);
      min-height: 100vh;
      padding: 0;
    }

    /* ── Header ── */
    header {
      padding: 28px 32px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 100;
    }

    .header-left h1 {
      font-size: 1.3rem;
      font-weight: 600;
      letter-spacing: -0.3px;
    }

    .header-left h1 span { color: var(--accent); }

    .header-meta {
      font-size: 0.75rem;
      color: var(--muted);
      font-family: var(--font-mono);
      margin-top: 3px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--green);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.4; }
    }

    .status-text {
      font-size: 0.75rem;
      color: var(--muted);
      font-family: var(--font-mono);
    }

    .btn-refresh {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 7px 14px;
      border-radius: 8px;
      font-size: 0.8rem;
      cursor: pointer;
      font-family: var(--font-body);
      transition: background 0.15s, border-color 0.15s;
    }

    .btn-refresh:hover { background: var(--surface); border-color: var(--accent); }

    /* ── Main Layout ── */
    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    /* ── Loading / Error ── */
    #loading, #error-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--muted);
      font-family: var(--font-mono);
      font-size: 0.85rem;
    }

    #error-state { color: var(--red); }

    /* ── Product Cards ── */
    .products-grid {
      display: grid;
      gap: 24px;
    }

    .product-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      animation: fadeUp 0.4s ease both;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .card-header {
      padding: 20px 24px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .product-name {
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: -0.2px;
    }

    .best-price-badge {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .best-price-label {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin-bottom: 2px;
    }

    .best-price-value {
      font-size: 1.6rem;
      font-weight: 600;
      font-family: var(--font-mono);
      color: var(--green);
      line-height: 1;
    }

    /* ── Retailer List ── */
    .retailers {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .retailer-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      border-radius: 8px;
      background: var(--surface2);
      transition: background 0.15s;
    }

    .retailer-row:hover { background: var(--border); }

    .retailer-row.is-best { border-left: 3px solid var(--green); }
    .retailer-row.is-failed { opacity: 0.5; }

    .retailer-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .retailer-name {
      font-size: 0.85rem;
      color: var(--text);
    }

    .retailer-name a {
      color: inherit;
      text-decoration: none;
    }

    .retailer-name a:hover { color: var(--accent); }

    .tag-best {
      font-size: 0.6rem;
      background: rgba(52, 217, 139, 0.15);
      color: var(--green);
      border: 1px solid rgba(52, 217, 139, 0.3);
      padding: 2px 7px;
      border-radius: 20px;
      font-family: var(--font-mono);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tag-failed {
      font-size: 0.6rem;
      background: rgba(247, 92, 92, 0.15);
      color: var(--red);
      border: 1px solid rgba(247, 92, 92, 0.3);
      padding: 2px 7px;
      border-radius: 20px;
      font-family: var(--font-mono);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .retailer-price {
      font-family: var(--font-mono);
      font-size: 0.9rem;
      font-weight: 500;
    }

    .retailer-price.is-best { color: var(--green); }
    .retailer-price.is-unavailable { color: var(--muted); font-style: italic; }

    /* ── Graph Section ── */
    .graph-section {
      padding: 20px 24px 24px;
    }

    .graph-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .graph-title {
      font-size: 0.75rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .timeframe-btns {
      display: flex;
      gap: 4px;
    }

    .tf-btn {
      padding: 4px 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      font-size: 0.72rem;
      cursor: pointer;
      font-family: var(--font-mono);
      transition: all 0.15s;
    }

    .tf-btn:hover { border-color: var(--accent); color: var(--text); }
    .tf-btn.active { background: var(--accent); border-color: var(--accent); color: white; }

    .graph-wrap {
      position: relative;
      height: 160px;
    }

    canvas {
      width: 100% !important;
    }

    /* ── Tooltip ── */
    .chart-tooltip {
      position: fixed;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 0.78rem;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s;
      z-index: 1000;
      min-width: 160px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }

    .chart-tooltip.visible { opacity: 1; }

    .tooltip-date {
      font-family: var(--font-mono);
      font-size: 0.7rem;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .tooltip-price {
      font-family: var(--font-mono);
      font-size: 1rem;
      font-weight: 500;
      color: var(--green);
      margin-bottom: 4px;
    }

    .tooltip-retailers {
      font-size: 0.72rem;
      color: var(--muted);
      line-height: 1.5;
    }

    /* ── No Data ── */
    .no-data {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--muted);
      font-size: 0.8rem;
      font-family: var(--font-mono);
    }

    /* ── Responsive ── */
    @media (max-width: 600px) {
      header { padding: 16px; }
      main { padding: 16px; }
      .card-header { flex-direction: column; align-items: flex-start; }
      .best-price-badge { align-items: flex-start; }
      .best-price-value { font-size: 1.3rem; }
      .graph-wrap { height: 130px; }
    }
  </style>
</head>
<body>

<header>
  <div class="header-left">
    <h1>Price <span>Tracker</span></h1>
    <div class="header-meta" id="last-updated">Loading data...</div>
  </div>
  <div class="header-right">
    <div class="status-dot"></div>
    <span class="status-text">Live</span>
    <button class="btn-refresh" onclick="loadData()">↻ Refresh</button>
  </div>
</header>

<main>
  <div id="loading">Fetching price data...</div>
  <div id="error-state" style="display:none"></div>
  <div id="products-grid" class="products-grid" style="display:none"></div>
</main>

<div class="chart-tooltip" id="tooltip"></div>

<script>
// ── Config ──────────────────────────────────────────────────────────────────
const CSV_URL = "https://raw.githubusercontent.com/Hafoozi/price-tracker/main/price_history.csv";

// Product categories — maps display name to the retailer name prefixes in CSV
const PRODUCTS = [
  { label: "Turin DF83 Gen 2 Grinder",    prefix: "Turin DF83 Grinder" },
  { label: "Lelit Bianca Espresso Machine", prefix: "Lelit Bianca" },
  { label: "Brake Free Tail Light",         prefix: "Brake Free Light" },
];

// ── State ────────────────────────────────────────────────────────────────────
let allRows = [];
let charts  = {};

// ── Data Loading ─────────────────────────────────────────────────────────────
async function loadData() {
  document.getElementById("loading").style.display = "block";
  document.getElementById("error-state").style.display = "none";
  document.getElementById("products-grid").style.display = "none";

  try {
    const res = await fetch(CSV_URL + "?t=" + Date.now());
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();

    const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
    allRows = parsed.data.map(r => ({
      timestamp: new Date(r.timestamp),
      name:      r.name.trim(),
      price:     parseFloat(r.price),
      url:       r.url.trim(),
    })).filter(r => !isNaN(r.price));

    if (allRows.length === 0) throw new Error("No data found in CSV");

    const lastTs = new Date(Math.max(...allRows.map(r => r.timestamp)));
    document.getElementById("last-updated").textContent =
      "Last updated: " + lastTs.toLocaleString("en-US", { month:"short", day:"numeric", hour:"numeric", minute:"2-digit" });

    renderDashboard();
  } catch (e) {
    document.getElementById("loading").style.display = "none";
    const el = document.getElementById("error-state");
    el.style.display = "block";
    el.textContent = "⚠ Could not load price data: " + e.message;
  }
}

// ── Render Dashboard ─────────────────────────────────────────────────────────
function renderDashboard() {
  const grid = document.getElementById("products-grid");
  grid.innerHTML = "";

  // Destroy old charts
  Object.values(charts).forEach(c => c.destroy && c.destroy());
  charts = {};

  PRODUCTS.forEach((product, idx) => {
    const retailers = getRetailers(product.prefix);
    const card = buildCard(product, retailers, idx);
    grid.appendChild(card);
  });

  document.getElementById("loading").style.display = "none";
  grid.style.display = "grid";

  // Draw charts after DOM is ready
  PRODUCTS.forEach((product, idx) => {
    drawChart(product, idx, "all");
  });
}

// ── Get Retailers for a Product ───────────────────────────────────────────────
function getRetailers(prefix) {
  const names = [...new Set(allRows.filter(r => r.name.startsWith(prefix)).map(r => r.name))];
  return names.map(name => {
    const rows   = allRows.filter(r => r.name === name);
    const latest = rows.reduce((a, b) => a.timestamp > b.timestamp ? a : b, rows[0]);
    return { name, price: latest?.price ?? null, url: latest?.url ?? "#", failed: !latest };
  });
}

// ── Build Card HTML ───────────────────────────────────────────────────────────
function buildCard(product, retailers, idx) {
  const prices    = retailers.filter(r => r.price !== null).map(r => r.price);
  const bestPrice = prices.length ? Math.min(...prices) : null;

  const card = document.createElement("div");
  card.className = "product-card";
  card.style.animationDelay = (idx * 0.08) + "s";

  // Header
  const header = document.createElement("div");
  header.className = "card-header";
  header.innerHTML = `
    <div class="product-name">${product.label}</div>
    <div class="best-price-badge">
      <div class="best-price-label">Lowest Price</div>
      <div class="best-price-value">${bestPrice !== null ? "$" + bestPrice.toFixed(2) : "—"}</div>
    </div>
  `;

  // Retailers
  const retailersEl = document.createElement("div");
  retailersEl.className = "retailers";

  retailers.forEach(r => {
    const isBest   = r.price !== null && r.price === bestPrice;
    const shortName = r.name.split(" - ")[1] || r.name;

    const row = document.createElement("div");
    row.className = "retailer-row" + (isBest ? " is-best" : "") + (r.failed ? " is-failed" : "");
    row.innerHTML = `
      <div class="retailer-info">
        <div class="retailer-name"><a href="${r.url}" target="_blank">${shortName}</a></div>
        ${isBest   ? '<span class="tag-best">Best</span>'     : ""}
        ${r.failed ? '<span class="tag-failed">No Data</span>' : ""}
      </div>
      <div class="retailer-price ${isBest ? "is-best" : ""} ${r.price === null ? "is-unavailable" : ""}">
        ${r.price !== null ? "$" + r.price.toFixed(2) : "unavailable"}
      </div>
    `;
    retailersEl.appendChild(row);
  });

  // Graph section
  const graphSection = document.createElement("div");
  graphSection.className = "graph-section";
  graphSection.innerHTML = `
    <div class="graph-controls">
      <div class="graph-title">Price History — Lowest Daily Price</div>
      <div class="timeframe-btns">
        <button class="tf-btn active" onclick="changeTimeframe(this, '${product.prefix}', ${idx}, 'all')">All</button>
        <button class="tf-btn" onclick="changeTimeframe(this, '${product.prefix}', ${idx}, '30d')">30D</button>
        <button class="tf-btn" onclick="changeTimeframe(this, '${product.prefix}', ${idx}, '14d')">14D</button>
        <button class="tf-btn" onclick="changeTimeframe(this, '${product.prefix}', ${idx}, '7d')">7D</button>
      </div>
    </div>
    <div class="graph-wrap">
      <canvas id="chart-${idx}"></canvas>
    </div>
  `;

  card.appendChild(header);
  card.appendChild(retailersEl);
  card.appendChild(graphSection);
  return card;
}

// ── Chart Drawing ─────────────────────────────────────────────────────────────
function getChartData(prefix, timeframe) {
  const rows = allRows.filter(r => r.name.startsWith(prefix));
  if (!rows.length) return { labels: [], prices: [], retailers: [] };

  // Filter by timeframe
  const now    = new Date();
  const days   = timeframe === "7d" ? 7 : timeframe === "14d" ? 14 : timeframe === "30d" ? 30 : null;
  const cutoff = days ? new Date(now - days * 86400000) : null;
  const filtered = cutoff ? rows.filter(r => r.timestamp >= cutoff) : rows;

  // Group by date — lowest price per day with which retailers matched
  const byDate = {};
  filtered.forEach(r => {
    const date = r.timestamp.toISOString().slice(0, 10);
    if (!byDate[date]) byDate[date] = [];
    byDate[date].push(r);
  });

  const labels   = [];
  const prices   = [];
  const retailers = [];

  Object.keys(byDate).sort().forEach(date => {
    const dayRows  = byDate[date];
    const minPrice = Math.min(...dayRows.map(r => r.price));
    const winners  = dayRows.filter(r => r.price === minPrice).map(r => r.name.split(" - ")[1] || r.name);
    labels.push(date);
    prices.push(minPrice);
    retailers.push({ price: minPrice, names: [...new Set(winners)] });
  });

  return { labels, prices, retailers };
}

function drawChart(product, idx, timeframe) {
  const { labels, prices, retailers } = getChartData(product.prefix, timeframe);
  const canvas = document.getElementById("chart-" + idx);
  if (!canvas) return;

  const ctx    = canvas.getContext("2d");
  const tooltip = document.getElementById("tooltip");

  if (charts[idx]) { charts[idx].destroy(); delete charts[idx]; }

  if (!labels.length) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const wrap = canvas.parentElement;
    wrap.innerHTML = '<div class="no-data">No data available for this timeframe</div>';
    return;
  }

  // Manual canvas chart (no Chart.js dependency)
  const dpr    = window.devicePixelRatio || 1;
  const wrap   = canvas.parentElement;
  const W      = wrap.clientWidth;
  const H      = wrap.clientHeight || 160;
  canvas.width  = W * dpr;
  canvas.height = H * dpr;
  ctx.scale(dpr, dpr);

  const pad   = { top: 12, right: 16, bottom: 32, left: 56 };
  const cW    = W - pad.left - pad.right;
  const cH    = H - pad.top - pad.bottom;
  const minP  = Math.min(...prices) * 0.98;
  const maxP  = Math.max(...prices) * 1.02;
  const range = maxP - minP || 1;

  const xPos = i => pad.left + (i / (labels.length - 1 || 1)) * cW;
  const yPos = p => pad.top + cH - ((p - minP) / range) * cH;

  // Grid lines
  ctx.strokeStyle = "#2e3347";
  ctx.lineWidth   = 1;
  [0, 0.25, 0.5, 0.75, 1].forEach(t => {
    const y = pad.top + t * cH;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + cW, y); ctx.stroke();
    const val = maxP - t * range;
    ctx.fillStyle = "#7b82a0";
    ctx.font = `10px DM Mono, monospace`;
    ctx.textAlign = "right";
    ctx.fillText("$" + val.toFixed(0), pad.left - 6, y + 3.5);
  });

  // Area fill
  const grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + cH);
  grad.addColorStop(0, "rgba(79,142,247,0.25)");
  grad.addColorStop(1, "rgba(79,142,247,0)");
  ctx.beginPath();
  ctx.moveTo(xPos(0), yPos(prices[0]));
  prices.forEach((p, i) => { if (i > 0) ctx.lineTo(xPos(i), yPos(p)); });
  ctx.lineTo(xPos(prices.length - 1), pad.top + cH);
  ctx.lineTo(xPos(0), pad.top + cH);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  // Line
  ctx.beginPath();
  ctx.strokeStyle = "#4f8ef7";
  ctx.lineWidth   = 2;
  ctx.lineJoin    = "round";
  prices.forEach((p, i) => {
    i === 0 ? ctx.moveTo(xPos(i), yPos(p)) : ctx.lineTo(xPos(i), yPos(p));
  });
  ctx.stroke();

  // Dots
  prices.forEach((p, i) => {
    ctx.beginPath();
    ctx.arc(xPos(i), yPos(p), 3.5, 0, Math.PI * 2);
    ctx.fillStyle = "#4f8ef7";
    ctx.fill();
    ctx.strokeStyle = "#0f1117";
    ctx.lineWidth = 1.5;
    ctx.stroke();
  });

  // X-axis labels (show max 6)
  ctx.fillStyle = "#7b82a0";
  ctx.font = "10px DM Mono, monospace";
  ctx.textAlign = "center";
  const step = Math.ceil(labels.length / 6);
  labels.forEach((l, i) => {
    if (i % step === 0 || i === labels.length - 1) {
      const d = new Date(l + "T12:00:00");
      const label = d.toLocaleDateString("en-US", { month:"short", day:"numeric" });
      ctx.fillText(label, xPos(i), H - 8);
    }
  });

  // Store chart data for tooltip
  charts[idx] = { labels, prices, retailers, xPos, yPos, pad, W, H, destroy: () => {} };

  // Tooltip interaction
  canvas.onmousemove = (e) => {
    const rect   = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const chart  = charts[idx];
    if (!chart) return;

    // Find nearest point
    let nearest = 0;
    let minDist = Infinity;
    chart.labels.forEach((_, i) => {
      const dist = Math.abs(chart.xPos(i) - mouseX);
      if (dist < minDist) { minDist = dist; nearest = i; }
    });

    if (minDist > 40) { tooltip.classList.remove("visible"); return; }

    const r    = chart.retailers[nearest];
    const date = new Date(chart.labels[nearest] + "T12:00:00");
    tooltip.innerHTML = `
      <div class="tooltip-date">${date.toLocaleDateString("en-US", { weekday:"short", month:"short", day:"numeric", year:"numeric" })}</div>
      <div class="tooltip-price">$${r.price.toFixed(2)}</div>
      <div class="tooltip-retailers">Lowest at: ${r.names.join(", ")}</div>
    `;
    tooltip.classList.add("visible");

    // Position tooltip
    const tx = e.clientX + 14;
    const ty = e.clientY - 20;
    tooltip.style.left = (tx + 180 > window.innerWidth ? e.clientX - 180 : tx) + "px";
    tooltip.style.top  = ty + "px";

    // Highlight dot
    const c2  = charts[idx];
    const dpr = window.devicePixelRatio || 1;
    ctx.clearRect(0, 0, canvas.width / dpr, canvas.height / dpr);
    drawChart(product, idx, timeframe);
    ctx.beginPath();
    ctx.arc(c2.xPos(nearest), c2.yPos(c2.prices[nearest]), 6, 0, Math.PI * 2);
    ctx.fillStyle = "#4f8ef7";
    ctx.fill();
    ctx.strokeStyle = "white";
    ctx.lineWidth = 2;
    ctx.stroke();
  };

  canvas.onmouseleave = () => { tooltip.classList.remove("visible"); };
}

function changeTimeframe(btn, prefix, idx, tf) {
  btn.closest(".timeframe-btns").querySelectorAll(".tf-btn").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");

  const wrap = document.getElementById("chart-" + idx)?.parentElement;
  if (wrap && !wrap.querySelector("canvas")) {
    wrap.innerHTML = `<canvas id="chart-${idx}"></canvas>`;
  }

  const product = PRODUCTS[idx];
  drawChart(product, idx, tf);
}

// ── Init ─────────────────────────────────────────────────────────────────────
loadData();
window.addEventListener("resize", () => {
  PRODUCTS.forEach((p, i) => {
    const activeTf = document.querySelector(`#chart-${i}`)
      ?.closest(".graph-section")
      ?.querySelector(".tf-btn.active")
      ?.textContent.toLowerCase().replace("all", "all") || "all";
    drawChart(p, i, activeTf === "all" ? "all" : activeTf);
  });
});
</script>
</body>
</html>
