<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Price Tracker v23</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#0f1117;--surface:#1a1d27;--surface2:#22263a;--border:#2e3347;
      --text:#e8eaf0;--muted:#9ba3c0;--accent:#4f8ef7;--green:#34d98b;
      --red:#f75c5c;--yellow:#f7c948;--orange:#f79c4f;
      --font:'DM Sans',sans-serif;--mono:'DM Mono',monospace;--radius:12px;
    }
    html,body{overflow-x:hidden;width:100%}
    body{background:var(--bg);color:var(--text);font-family:var(--font);min-height:100vh;font-size:16px}

    /* â”€â”€ Header â”€â”€ */
    header{background:var(--bg);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;padding:18px 32px}
    .hdr-top{display:flex;align-items:center;justify-content:space-between;gap:8px;width:100%}
    .hdr-left h1{font-size:1.5rem;font-weight:600;letter-spacing:-0.4px}
    .hdr-left h1 span{color:var(--accent)}
    .hdr-meta{font-size:0.74rem;color:var(--muted);font-family:var(--mono);margin-top:5px;display:flex;align-items:center;gap:12px}
    .hdr-error{color:var(--yellow);display:none}
    .hdr-controls{display:flex;align-items:center;gap:6px;flex-wrap:nowrap;flex-shrink:0}

    /* Status */
    .status-wrap{display:flex;align-items:center;gap:5px;position:relative;cursor:default}
    .sdot{width:9px;height:9px;border-radius:50%;animation:pulse 2s infinite;flex-shrink:0}
    .sdot.green{background:var(--green)}.sdot.yellow{background:var(--yellow)}.sdot.red{background:var(--red)}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
    .slabel{font-size:0.7rem;color:var(--muted);font-family:var(--mono);white-space:nowrap}
    .stip{position:absolute;top:calc(100% + 8px);left:0;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 13px;font-size:0.68rem;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .15s;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,.6)}
    .status-wrap:hover .stip{opacity:1}
    .dot-row{display:flex;align-items:center;gap:7px;margin-bottom:4px}
    .dot-row:last-child{margin-bottom:0}
    .mdot{width:7px;height:7px;border-radius:50%;flex-shrink:0}

    /* Buttons */
    .btn{padding:9px 17px;border-radius:8px;font-size:0.82rem;cursor:pointer;font-family:var(--font);border:1px solid var(--border);transition:all .15s;white-space:nowrap;-webkit-tap-highlight-color:transparent;line-height:1}
    .btn-sec{background:var(--surface2);color:var(--text)}.btn-sec:active{border-color:var(--accent)}
    .btn-pri{background:var(--accent);color:#fff;border-color:var(--accent)}.btn-pri:active{background:#3a7ae0}
    .btn-pau{background:rgba(247,201,72,.12);color:var(--yellow);border-color:rgba(247,201,72,.3)}
    .btn-dan{background:rgba(247,92,92,.12);color:var(--red);border-color:rgba(247,92,92,.3)}

    /* Mobile hamburger dropdown */
    .mob-dd-wrap{position:relative}
    .mob-dd{position:absolute;top:calc(100% + 6px);right:0;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:5px;min-width:180px;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,.6)}
    .mob-dd.hidden{display:none}

    /* Reorder banner */
    .reorder-banner{display:none;background:rgba(79,142,247,.1);border-bottom:1px solid rgba(79,142,247,.3);padding:7px 16px;font-size:0.75rem;color:var(--accent);text-align:center}
    .reorder-banner.active{display:block}

    /* Main */
    main{max-width:820px;margin:0 auto;padding:18px 24px}
    #loading,#err{text-align:center;padding:60px 16px;color:var(--muted);font-family:var(--mono);font-size:0.82rem}
    #err{color:var(--red)}
    .grid{display:grid;gap:12px}

    /* Card */
    .pcard{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);animation:fadeUp .3s ease both;transition:border-color .15s}
    .pcard.drag-over{border-color:var(--accent);border-style:dashed}
    .pcard.dragging{opacity:.4}
    @keyframes fadeUp{from{opacity:0;transform:translateY(7px)}to{opacity:1;transform:translateY(0)}}

    /* Card header */
    .card-hdr{padding:15px 18px;display:flex;align-items:center;gap:12px;cursor:pointer;user-select:none;-webkit-tap-highlight-color:transparent}
    .card-hdr:active{background:rgba(255,255,255,.02);border-radius:var(--radius)}

    /* Drag handle */
    .dhandle{display:none;flex-direction:column;gap:3px;padding:5px 4px;cursor:grab;flex-shrink:0;color:var(--muted);border-radius:4px;touch-action:none}
    .dhandle:active{color:var(--accent)}
    .dhandle span{display:block;width:14px;height:2px;background:currentColor;border-radius:2px}
    .reorder-mode .dhandle{display:flex}

    /* Image */
    .pimg,.pimg-ph{width:56px;height:56px;border-radius:9px;flex-shrink:0;border:1px solid var(--border)}
    .pimg{object-fit:cover;background:var(--surface2)}
    .pimg-ph{background:var(--surface2);display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:1rem}

    /* Header info */
    .card-info{flex:1;min-width:0}
    .pname{font-size:0.95rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text)}
    .psub{display:flex;align-items:center;gap:5px;margin-top:3px;flex-wrap:wrap}
    .rcount{font-size:0.66rem;color:var(--muted);font-family:var(--mono)}

    /* Warning badge with tooltip */
    .warn-wrap{position:relative;display:inline-flex;align-items:center;cursor:default}
    .warn-icon{font-size:0.7rem;color:var(--yellow)}
    .warn-tip{position:absolute;bottom:calc(100% + 5px);left:50%;transform:translateX(-50%);background:var(--surface2);border:1px solid rgba(247,201,72,.4);border-radius:7px;padding:5px 9px;font-size:0.65rem;color:var(--yellow);white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .15s;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,.4)}
    .warn-wrap:hover .warn-tip,.warn-wrap:active .warn-tip{opacity:1}

    /* Price block */
    .card-right{display:flex;align-items:center;gap:7px;flex-shrink:1;min-width:0}
    .price-blk{text-align:right;min-width:60px}
    .price-cur{font-size:1.3rem;font-weight:600;font-family:var(--mono);color:var(--green);line-height:1.1}
    .price-cur.none{color:var(--muted);font-size:.85rem}
    .price-vs{font-size:0.65rem;font-family:var(--mono);margin-top:3px;white-space:nowrap}
    .pv-below{color:var(--green)}.pv-above{color:var(--orange)}.pv-near{color:var(--muted)}

    /* Card â‹¯ menu */
    .mbtn{width:32px;height:32px;border-radius:7px;border:1px solid var(--border);background:var(--surface2);color:var(--muted);font-size:1.15rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;-webkit-tap-highlight-color:transparent;transition:all .15s}
    .mbtn:active{border-color:var(--accent);color:var(--text)}
    .cmenu{position:fixed;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:5px;min-width:170px;z-index:9999;box-shadow:0 8px 28px rgba(0,0,0,.7)}
    .cmenu.hidden{display:none}
    .mitem{display:flex;align-items:center;padding:11px 12px;border-radius:7px;font-size:0.82rem;cursor:pointer;color:var(--text);-webkit-tap-highlight-color:transparent}
    .mitem:active{background:var(--border)}
    .mitem.danger{color:var(--red)}
    .mitem.danger:active{background:rgba(247,92,92,.12)}
    .mdiv{height:1px;background:var(--border);margin:3px 0}

    /* Card body */
    .card-body{overflow:hidden;max-height:0;transition:max-height .3s ease}
    .card-body.open{max-height:2500px;border-top:1px solid var(--border)}

    /* Retailers */
    .rets{padding:10px 16px;border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:5px}
    .rrow{display:flex;align-items:center;justify-content:space-between;padding:10px 13px;border-radius:8px;background:var(--surface2);gap:8px}
    .rrow.best-row{border-left:3px solid var(--green)}
    .rrow.fail-row{opacity:.55}
    .rrow.err-row{border-left:3px solid var(--yellow)}
    .rinfo{display:flex;align-items:center;gap:6px;flex-wrap:wrap;min-width:0;flex:1}
    .rname a{color:var(--text);text-decoration:none;font-size:0.88rem;font-weight:500}
    .rname a:active{color:var(--accent)}
    .tag{font-size:0.58rem;padding:2px 6px;border-radius:20px;font-family:var(--mono);text-transform:uppercase;letter-spacing:.4px;flex-shrink:0}
    .tag-best{background:rgba(52,217,139,.15);color:var(--green);border:1px solid rgba(52,217,139,.3)}
    .tag-nd{background:rgba(247,92,92,.15);color:var(--red);border:1px solid rgba(247,92,92,.3)}
    .tag-err{background:rgba(247,201,72,.15);color:var(--yellow);border:1px solid rgba(247,201,72,.3)}
    .tag-oos{background:rgba(247,156,79,.15);color:var(--orange);border:1px solid rgba(247,156,79,.3)}
    .rprice{font-family:var(--mono);font-size:0.88rem;font-weight:600;flex-shrink:0}
    .rprice.oos-price{color:var(--muted);text-decoration:line-through;font-weight:400}
    .rprice.best{color:var(--green)}.rprice.na{color:var(--muted);font-style:italic;font-size:.72rem}

    /* Add retailer */
    .addr-row{padding:8px 16px 13px}
    .addr-form{display:none;gap:6px;flex-wrap:wrap;margin-top:6px}
    .addr-form.open{display:flex}
    .addr-form input{flex:1;min-width:110px;padding:7px 10px;border-radius:7px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:0.78rem;font-family:var(--font);outline:none}
    .addr-form input:focus{border-color:var(--accent)}
    .btn-addr{font-size:0.7rem;color:var(--muted);background:none;border:1px dashed var(--border);border-radius:7px;padding:6px 10px;cursor:pointer}
    .btn-addr:active{border-color:var(--accent);color:var(--accent)}

    /* Graph */
    .gsec{padding:12px 16px 16px}
    .gctrl{display:flex;align-items:center;justify-content:space-between;margin-bottom:9px;gap:6px}
    .glbl{font-size:0.63rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
    .tfbtns{display:flex;gap:2px;flex-wrap:nowrap}
    .tfbtn{padding:4px 10px;border-radius:5px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:0.67rem;cursor:pointer;font-family:var(--mono);-webkit-tap-highlight-color:transparent}
    .tfbtn:active{border-color:var(--accent)}
    .tfbtn.active{background:var(--accent);border-color:var(--accent);color:#fff}
    .gwrap{position:relative;height:140px}
    canvas{width:100%!important;display:block}
    .nodata{display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted);font-size:0.72rem;font-family:var(--mono)}

    /* Chart tooltip */
    .ctip{position:fixed;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:0.72rem;pointer-events:none;opacity:0;transition:opacity .15s;z-index:9998;min-width:145px;box-shadow:0 8px 20px rgba(0,0,0,.4)}
    .ctip.on{opacity:1}
    .ctip-date{font-family:var(--mono);font-size:0.6rem;color:var(--muted);margin-bottom:3px}
    .ctip-price{font-family:var(--mono);font-size:0.88rem;font-weight:500;color:var(--green);margin-bottom:2px}
    .ctip-store{font-size:0.62rem;color:var(--muted);line-height:1.4}

    /* Modals */
    .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:200;align-items:center;justify-content:center;padding:14px}
    .overlay.open{display:flex}
    .modal{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:22px;width:100%;max-width:440px}
    .modal h2{font-size:0.92rem;margin-bottom:14px;color:var(--text)}
    .modal label{display:block;font-size:0.72rem;color:var(--muted);margin-bottom:4px;margin-top:12px}
    .modal input{width:100%;padding:9px 11px;border-radius:7px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:0.82rem;font-family:var(--font);outline:none}
    .modal input:focus{border-color:var(--accent)}
    .mfooter{display:flex;justify-content:flex-end;gap:7px;margin-top:18px}
    .smmodal{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;width:100%;max-width:340px}
    .smmodal h2{font-size:0.9rem;color:var(--text)}
    .smmodal p{font-size:0.82rem;color:var(--muted);margin-top:6px;line-height:1.55}
    .smfooter{display:flex;justify-content:flex-end;gap:7px;margin-top:15px}
    .pause-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;width:100%;max-width:390px}
    .pause-box h2{font-size:0.9rem;color:var(--text);margin-bottom:5px}
    .pause-box p{font-size:0.76rem;color:var(--muted);margin-bottom:13px;line-height:1.5}
    .prow{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)}
    .prow:last-of-type{border-bottom:none}
    .plbl{font-size:0.82rem;color:var(--text)}
    .psub{font-size:0.63rem;color:var(--muted);font-family:var(--mono);margin-top:2px}
    .sw{position:relative;width:38px;height:20px;flex-shrink:0}
    .sw input{opacity:0;width:0;height:0;position:absolute}
    .sl{position:absolute;inset:0;background:var(--border);border-radius:20px;cursor:pointer;transition:.2s}
    .sl:before{content:'';position:absolute;width:14px;height:14px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.2s}
    .sw input:checked+.sl{background:var(--green)}
    .sw input:checked+.sl:before{transform:translateX(18px)}
    .pfooter{display:flex;justify-content:flex-end;margin-top:13px}

    /* Toast */
    .toast{position:fixed;bottom:14px;right:14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px 14px;font-size:0.75rem;font-family:var(--mono);color:var(--muted);opacity:0;transition:opacity .2s;z-index:300;pointer-events:none}
    .toast.on{opacity:1}


    /* â”€â”€ Desktop: > 767px â”€â”€ */
    @media(min-width:768px){
      .mob-only{display:none!important}
      .desk-only{display:flex!important}
    }

    /* â”€â”€ Mobile: â‰¤ 767px â”€â”€ */
    @media(max-width:767px){
      .desk-only{display:none!important}
      .mob-only{display:flex!important}
      header{padding:10px 12px}
      .hdr-top{flex-wrap:nowrap}
      .hdr-left h1{font-size:1rem}
      .hdr-meta{font-size:0.62rem;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
      .btn{padding:7px 11px;font-size:0.76rem}
      main{padding:10px 10px}
      .card-hdr{padding:10px 11px;gap:7px}
      .pimg,.pimg-ph{width:38px;height:38px;border-radius:6px}
      .pname{font-size:0.87rem}
      .rcount{font-size:0.63rem}
      .price-cur{font-size:1rem}
      .card-right{gap:5px}
      .price-blk{min-width:55px}
      .price-vs{font-size:0.59rem}
      .mbtn{width:30px;height:30px;font-size:1rem}
      .mitem{padding:13px 12px;font-size:0.84rem}
      .tfbtn{padding:5px 8px;font-size:0.65rem}
      .gwrap{height:115px}
      .rrow{padding:9px 10px}
      .rname a{font-size:0.82rem}
      .rprice{font-size:0.82rem}
      .mob-dd{min-width:185px}
      .pimg,.pimg-ph{display:none}
      .card-right{gap:4px;flex-shrink:0}
      .price-blk{min-width:58px;max-width:100px}
      .price-vs{font-size:0.55rem;white-space:normal;line-height:1.3;text-align:right}
      .gctrl{flex-wrap:wrap;gap:4px}
      .tfbtns{gap:2px}
      .tfbtn{padding:4px 7px;font-size:0.62rem}
    }
  </style>
</head>
<body>

<header>
  <div class="hdr-top">
    <div class="hdr-left">
      <h1>Price <span>Tracker</span></h1>
      <div class="hdr-meta">
        <span id="last-updated">Loading...</span>
        <span class="hdr-error" id="hdr-err"></span>
      </div>
    </div>
    <div class="hdr-controls">
      <!-- Status (always visible) -->
      <div class="status-wrap">
        <div class="sdot green" id="sdot"></div>
        <span class="slabel">Live</span>
        <div class="stip">
          <div class="dot-row"><div class="mdot" style="background:var(--green)"></div>Current â€” under 2 hrs</div>
          <div class="dot-row"><div class="mdot" style="background:var(--yellow)"></div>Stale â€” 2 to 14 hrs</div>
          <div class="dot-row"><div class="mdot" style="background:var(--red)"></div>Outdated â€” over 14 hrs</div>
        </div>
      </div>
      <!-- Desktop buttons -->
      <div class="desk-only" style="gap:6px;align-items:center">
        <button class="btn btn-sec" id="tog-btn" onclick="smartToggle()">Expand All</button>
        <button class="btn btn-sec" onclick="loadData()">Reload</button>
        <button class="btn btn-pau" onclick="openPause()">Pause</button>
        <button class="btn btn-pri" onclick="openAdd()">+ Add Product</button>
      </div>
      <!-- Mobile buttons -->
      <div class="mob-only" style="gap:6px;align-items:center">
        <button class="btn btn-pri" onclick="openAdd()">+</button>
        <div class="mob-dd-wrap">
          <button class="btn btn-sec" onclick="toggleMobMenu(event)">â˜°</button>
          <div class="mob-dd hidden" id="mob-dd">
            <div class="mitem" id="mob-tog-item" onclick="smartToggle();closeMobMenu()">Expand All</div>
            <div class="mitem" onclick="enterReorder();closeMobMenu()">Reorder Cards</div>
            <div class="mitem" onclick="loadData();closeMobMenu()">Reload Data</div>
            <div class="mitem" onclick="openPause();closeMobMenu()">Pause Tracking</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<div class="reorder-banner" id="rbanner">
  Reorder mode â€” drag to rearrange &nbsp;Â·&nbsp;
  <a href="#" onclick="exitReorder();return false" style="color:var(--accent)">Done</a>
</div>

<main>
  <div id="loading">Fetching price data...</div>
  <div id="err" style="display:none"></div>
  <div id="grid" class="grid" style="display:none"></div>
</main>

<!-- Add Product -->
<div class="overlay" id="add-modal">
  <div class="modal">
    <h2>Add New Product</h2>
    <label>Product Name</label><input id="nb-lbl" type="text" placeholder="e.g. Breville Barista Express"/>
    <label>First Retailer Name</label><input id="nb-ret" type="text" placeholder="e.g. Amazon"/>
    <label>Product URL</label><input id="nb-url" type="url" placeholder="https://..."/>
    <div class="mfooter">
      <button class="btn btn-sec" onclick="closeAdd()">Cancel</button>
      <button class="btn btn-pri" onclick="confirmAdd()">Add</button>
    </div>
  </div>
</div>

<!-- Rename -->
<div class="overlay" id="ren-modal">
  <div class="smmodal">
    <h2>Rename Product</h2>
    <input id="ren-inp" type="text" style="width:100%;margin-top:12px;padding:9px 11px;border-radius:7px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:0.85rem;font-family:var(--font);outline:none"/>
    <div class="smfooter">
      <button class="btn btn-sec" onclick="closeRen()">Cancel</button>
      <button class="btn btn-pri" onclick="confirmRen()">Save</button>
    </div>
  </div>
</div>

<!-- Confirm -->
<div class="overlay" id="conf-modal">
  <div class="smmodal">
    <h2 id="conf-title">Are you sure?</h2>
    <p id="conf-msg"></p>
    <div class="smfooter">
      <button class="btn btn-sec" onclick="closeConf()">Cancel</button>
      <button class="btn btn-dan" id="conf-btn">Delete</button>
    </div>
  </div>
</div>

<!-- Pause -->
<div class="overlay" id="pau-modal">
  <div class="pause-box">
    <h2>Pause / Resume Tracking</h2>
    <p>Toggle workflows on or off in GitHub Actions.</p>
    <div class="prow">
      <div><div class="plbl">Hourly Price Scraper</div><div class="psub">5 AMâ€“9 PM Eastern daily</div></div>
      <label class="sw"><input type="checkbox" id="sw-norm" checked onchange="toggleWF(this.checked)"/><span class="sl"></span></label>
    </div>
    <div class="prow">
      <div><div class="plbl">Weekly Summary Email</div><div class="psub">Sundays 9:30 PM Eastern</div></div>
      <label class="sw"><input type="checkbox" id="sw-week" checked onchange="toggleWF(this.checked,true)"/><span class="sl"></span></label>
    </div>
    <div class="pfooter"><button class="btn btn-sec" onclick="closePause()">Close</button></div>
  </div>
</div>

<div class="ctip" id="ctip"></div>
<div class="toast" id="toast"></div>

<script>
const GHU='Hafoozi',GHR='price-tracker',GHB='main';
const CSV_URL=`https://raw.githubusercontent.com/${GHU}/${GHR}/${GHB}/price_history.csv`;
const CFG_URL=`https://raw.githubusercontent.com/${GHU}/${GHR}/${GHB}/config.json`;
const API=`https://api.github.com/repos/${GHU}/${GHR}`;

let tok=localStorage.getItem('gh_token')||'';
let rows=[],cfg=null,charts={},confCb=null;
let cState={},reorderMode=false,renIdx=-1;
let activeMenu=null,activeMenuIdx=-1;

function getToken(){if(!tok){tok=prompt('Enter GitHub Personal Access Token:');if(tok)localStorage.setItem('gh_token',tok);}return tok;}

// â”€â”€ TIMESTAMP FIX: parse CSV timestamps as UTC explicitly â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CSV format: "2026-02-23 01:45:00" (GitHub Actions = UTC, no timezone marker)
// new Date("2026-02-23 01:45:00") is ambiguous â€” parsed as local in Chrome, invalid in Safari
// Fix: replace space with T and append Z to force UTC interpretation
function parseUTC(str){
  if(!str)return new Date(NaN);
  // Already has T and Z â€” leave alone
  if(str.includes('T')&&str.endsWith('Z'))return new Date(str);
  // "2026-02-23 01:45:00" â†’ "2026-02-23T01:45:00Z"
  return new Date(str.replace(' ','T')+'Z');
}

// Convert UTC date to Eastern Time string (handles EST/EDT automatically)
function toET(d){
  if(!d||isNaN(d))return 'â€”';
  const mobile=window.innerWidth<=767;
  if(mobile){
    // Short: 2/23/26 8:45 PM ET
    return d.toLocaleString('en-US',{timeZone:'America/New_York',month:'numeric',day:'numeric',year:'2-digit',hour:'numeric',minute:'2-digit'});
  }
  return d.toLocaleString('en-US',{timeZone:'America/New_York',month:'short',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit'});
}

// â”€â”€ Status dot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStatus(r){
  if(!r.length)return;
  const age=(Date.now()-Math.max(...r.map(x=>x.ts)))/3600000;
  document.getElementById('sdot').className='sdot '+(age<2?'green':age<14?'yellow':'red');
}

// â”€â”€ Load data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData(){
  document.getElementById('loading').style.display='block';
  document.getElementById('err').style.display='none';
  document.getElementById('grid').style.display='none';
  document.getElementById('hdr-err').style.display='none';
  try{
    const[cr,cfr]=await Promise.all([fetch(CSV_URL+'?t='+Date.now()),fetch(CFG_URL+'?t='+Date.now())]);
    if(!cr.ok)throw new Error('CSV '+cr.status);
    if(!cfr.ok)throw new Error('Config '+cfr.status);
    cfg=await cfr.json();
    const p=Papa.parse(await cr.text(),{header:true,skipEmptyLines:true});
    rows=p.data.filter(r=>r.name&&r.price&&r.timestamp).map(r=>({
      ts:parseUTC(r.timestamp),  // â† UTC fix applied here
      name:r.name.trim(),
      price:parseFloat(r.price),
      url:(r.url||'').trim(),
      img:(r.image||'').trim(),
      oos:(r.oos||'').trim()==='1'  // out-of-stock flag from tracker
    })).filter(r=>!isNaN(r.price)&&!isNaN(r.ts));

    // Last updated in ET
    const names=new Set(cfg.buckets.flatMap(b=>b.retailers.map(r=>`${b.label} - ${r.name}`)));
    const cur=rows.filter(r=>names.has(r.name));
    const srcRows=cur.length?cur:rows;
    const latestTs=new Date(Math.max(...srcRows.map(r=>r.ts)));
    document.getElementById('last-updated').textContent='Last updated: '+toET(latestTs);

    // Error detection
    if(cur.length){
      const maxTs=Math.max(...cur.map(r=>r.ts));
      const bad=[...names].filter(n=>!cur.some(r=>r.name===n&&Math.abs(r.ts-maxTs)<7200000));
      if(bad.length){
        const el=document.getElementById('hdr-err');
        el.style.display='inline';
        el.textContent=` Â· âš  ${bad.length} retailer${bad.length>1?'s':''} failed last run`;
      }
    }

    updateStatus(rows);
    render();
  }catch(e){
    document.getElementById('loading').style.display='none';
    const el=document.getElementById('err');el.style.display='block';el.textContent='âš  '+e.message;
  }
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(){
  const grid=document.getElementById('grid');
  grid.innerHTML='';
  Object.values(charts).forEach(c=>c&&c.destroy&&c.destroy());charts={};
  const mobile=window.innerWidth<=767;
  cfg.buckets.forEach((b,i)=>{
    const open=cState[i]!==undefined?cState[i]:false;
    grid.appendChild(buildCard(b,i,open));
  });
  document.getElementById('loading').style.display='none';
  grid.style.display='grid';
  if(reorderMode)grid.classList.add('reorder-mode');
  cfg.buckets.forEach((b,i)=>{if(cState[i]!==undefined?cState[i]:false)drawChart(b,i,'all');});
  updTogBtn();initDrag();closeAllMenus();
}

// â”€â”€ Smart toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function smartToggle(){
  const anyOpen=cfg.buckets.some((_,i)=>{const c=document.querySelector(`.pcard[data-idx="${i}"]`);return c&&c.querySelector('.card-body').classList.contains('open');});
  cfg.buckets.forEach((_,i)=>{
    const card=document.querySelector(`.pcard[data-idx="${i}"]`);if(!card)return;
    const body=card.querySelector('.card-body');
    if(!anyOpen){body.classList.add('open');cState[i]=true;setTimeout(()=>drawChart(cfg.buckets[i],i,getTf(i)),60);}
    else{body.classList.remove('open');cState[i]=false;}
  });
  updTogBtn();
}
function updTogBtn(){
  const anyOpen=cfg.buckets.some((_,i)=>{const c=document.querySelector(`.pcard[data-idx="${i}"]`);return c&&c.querySelector('.card-body').classList.contains('open');});
  const label=anyOpen?'Collapse All':'Expand All';
  const btn=document.getElementById('tog-btn');if(btn)btn.textContent=label;
  const mobItem=document.getElementById('mob-tog-item');if(mobItem)mobItem.textContent=label;
}

// â”€â”€ Retailer data helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getRetData(bucket){
  const bRows=rows.filter(r=>bucket.retailers.some(ret=>r.name===`${bucket.label} - ${ret.name}`));
  const maxTs=bRows.length?Math.max(...bRows.map(r=>r.ts)):null;
  return bucket.retailers.map(r=>{
    const name=`${bucket.label} - ${r.name}`;
    const rr=rows.filter(x=>x.name===name);
    const last=rr.length?rr.reduce((a,b)=>a.ts>b.ts?a:b):null;
    const inLast=maxTs&&rr.some(x=>Math.abs(x.ts-maxTs)<7200000);
    return{name:r.name,url:r.url,price:last?.price??null,img:last?.img??'',oos:last?.oos??false,failed:!last,error:rr.length>0&&maxTs&&!inLast};
  });
}

function getAvg(bucket){
  const br=rows.filter(r=>bucket.retailers.some(ret=>r.name===`${bucket.label} - ${ret.name}`));
  if(br.length<6)return null;
  const byDay={};
  br.filter(r=>!r.oos).forEach(r=>{const d=r.ts.toISOString().slice(0,10);if(!byDay[d])byDay[d]=[];byDay[d].push(r.price);});
  const lows=Object.values(byDay).map(p=>Math.min(...p));
  return lows.reduce((a,b)=>a+b,0)/lows.length;
}

// â”€â”€ Build warning badge with tooltip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function warnBadge(msgs){
  if(!msgs.length)return'';
  const tip=msgs.join(' Â· ');
  return`<span class="warn-wrap"><span class="warn-icon">âš </span><span class="warn-tip">${tip}</span></span>`;
}

// â”€â”€ Build card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildCard(bucket,idx,isOpen){
  const rets=getRetData(bucket);
  const prices=rets.filter(r=>r.price!==null&&!r.oos).map(r=>r.price);
  const best=prices.length?Math.min(...prices):null;
  const avg=getAvg(bucket);

  // Warning icon only for actual data errors â€” NOT sold out (that's shown inline)
  const warnMsgs=[];
  const failedCount=rets.filter(r=>r.failed&&!r.error).length;
  const errCount=rets.filter(r=>r.error).length;
  if(failedCount)warnMsgs.push(`${failedCount} retailer${failedCount>1?'s':''} have no data`);
  if(errCount)warnMsgs.push(`${errCount} retailer${errCount>1?'s':''} failed last run`);

  // Price vs avg
  let vsHtml='';
  if(best!==null&&avg!==null){
    const pct=((avg-best)/avg*100),diff=Math.abs(avg-best).toFixed(0);
    if(Math.abs(pct)<1)vsHtml=`<div class="price-vs pv-near">â‰ˆ near avg ($${avg.toFixed(0)})</div>`;
    else if(best<avg)vsHtml=`<div class="price-vs pv-below">â†“ ${Math.abs(pct).toFixed(1)}% ($${diff} below avg)</div>`;
    else vsHtml=`<div class="price-vs pv-above">â†‘ ${Math.abs(pct).toFixed(1)}% ($${diff} above avg)</div>`;
  }

  const img=rets.find(r=>r.img)?.img||'';
  const imgHtml=img
    ?`<img class="pimg" src="${img}" alt="" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"/><div class="pimg-ph" style="display:none">ğŸ›</div>`
    :`<div class="pimg-ph">ğŸ›</div>`;

  const card=document.createElement('div');
  card.className='pcard';card.dataset.idx=idx;card.draggable=false;
  card.style.animationDelay=(idx*0.05)+'s';

  const hdr=document.createElement('div');hdr.className='card-hdr';
  hdr.innerHTML=`
    <div class="dhandle" onclick="event.stopPropagation()"><span></span><span></span><span></span></div>
    ${imgHtml}
    <div class="card-info">
      <div class="pname">${bucket.label}</div>
      <div class="psub">
        <span class="rcount">${rets.length} retailer${rets.length!==1?'s':''}</span>
        ${warnBadge(warnMsgs)}
      </div>
    </div>
    <div class="card-right">
      <div class="price-blk">
        <div class="price-cur ${best===null?'none':''}">${best!==null?'$'+best.toFixed(2):'â€”'}</div>
        ${vsHtml}
      </div>
      <button class="mbtn" onclick="event.stopPropagation();toggleCardMenu(event,${idx})">â‹¯</button>
    </div>`;
  hdr.addEventListener('click',()=>toggleCard(idx));

  const body=document.createElement('div');body.className='card-body'+(isOpen?' open':'');

  // Retailers
  const retEl=document.createElement('div');retEl.className='rets';
  rets.forEach(r=>{
    const isBest=r.price!==null&&r.price===best&&!r.oos;
    const row=document.createElement('div');
    row.className='rrow'+(isBest?' best-row':'')+(r.failed&&!r.error?' fail-row':'')+(r.error?' err-row':'');
    row.innerHTML=`
      <div class="rinfo">
        <div class="rname"><a href="${r.url}" target="_blank">${r.name}</a></div>
        ${isBest?'<span class="tag tag-best">Best</span>':''}
        ${r.failed&&!r.error?'<span class="tag tag-nd">No Data</span>':''}
        ${r.error?'<span class="tag tag-err">Failed</span>':''}
        ${r.oos?'<span class="tag tag-oos">Sold Out</span>':''}
      </div>
      <div class="rprice ${r.oos?'oos-price':isBest?'best':''} ${r.price===null?'na':''}">${r.price!==null?'$'+r.price.toFixed(2):'unavailable'}</div>`;
    retEl.appendChild(row);
  });

  // Add retailer
  const addR=document.createElement('div');addR.className='addr-row';
  addR.innerHTML=`
    <button class="btn-addr" onclick="toggleAddR(this)">+ Add retailer</button>
    <div class="addr-form">
      <input type="text" placeholder="Retailer name" class="rn"/>
      <input type="url" placeholder="Product URL" class="ru"/>
      <button class="btn btn-pri" style="font-size:.72rem;padding:6px 10px" onclick="addRet(this,${idx})">Add</button>
      <button class="btn btn-sec" style="font-size:.72rem;padding:6px 10px" onclick="toggleAddR(this.parentElement.previousElementSibling)">Cancel</button>
    </div>`;

  // Graph
  const gEl=document.createElement('div');gEl.className='gsec';
  gEl.innerHTML=`
    <div class="gctrl">
      <div class="glbl">Price History</div>
      <div class="tfbtns">
        <button class="tfbtn active" onclick="changeTf(this,${idx},'all')">All</button>
        <button class="tfbtn" onclick="changeTf(this,${idx},'30d')">30D</button>
        <button class="tfbtn" onclick="changeTf(this,${idx},'14d')">14D</button>
        <button class="tfbtn" onclick="changeTf(this,${idx},'7d')">7D</button>
      </div>
    </div>
    <div class="gwrap"><canvas id="chart-${idx}"></canvas></div>`;

  body.appendChild(retEl);body.appendChild(addR);body.appendChild(gEl);
  card.appendChild(hdr);card.appendChild(body);
  return card;
}

// â”€â”€ Toggle card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleCard(idx){
  const card=document.querySelector(`.pcard[data-idx="${idx}"]`);if(!card)return;
  const body=card.querySelector('.card-body');
  const willOpen=!body.classList.contains('open');
  if(willOpen){body.classList.add('open');cState[idx]=true;setTimeout(()=>drawChart(cfg.buckets[idx],idx,getTf(idx)),50);}
  else{body.classList.remove('open');cState[idx]=false;}
  updTogBtn();
}
function getTf(idx){return document.querySelector(`#chart-${idx}`)?.closest('.gsec')?.querySelector('.tfbtn.active')?.textContent.toLowerCase()||'all';}

// â”€â”€ Card â‹¯ menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleCardMenu(e,idx){
  e.stopPropagation();
  if(activeMenuIdx===idx){closeAllMenus();return;}
  closeAllMenus();
  activeMenuIdx=idx;
  const rect=e.currentTarget.getBoundingClientRect();
  const menu=document.createElement('div');
  menu.className='cmenu';menu.id='active-cmenu';
  menu.innerHTML=`
    <div class="mitem" onclick="openRen(${idx});closeAllMenus()">Rename Product</div>
    <div class="mitem" onclick="enterReorder();closeAllMenus()">Reorder Cards</div>
    <div class="mdiv"></div>
    <div class="mitem danger" onclick="delBucket(${idx});closeAllMenus()">Delete Product</div>`;
  document.body.appendChild(menu);activeMenu=menu;
  const mW=170;
  const left=Math.max(8,Math.min(rect.right-mW,window.innerWidth-mW-8));
  menu.style.top=(rect.bottom+5)+'px';menu.style.left=left+'px';
}
function closeAllMenus(){
  document.getElementById('active-cmenu')?.remove();
  activeMenu=null;activeMenuIdx=-1;
  document.getElementById('mob-dd')?.classList.add('hidden');
}
document.addEventListener('click',()=>closeAllMenus());

// â”€â”€ Mobile menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleMobMenu(e){e.stopPropagation();document.getElementById('mob-dd').classList.toggle('hidden');}
function closeMobMenu(){document.getElementById('mob-dd')?.classList.add('hidden');}

// â”€â”€ Reorder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function enterReorder(){reorderMode=true;document.getElementById('rbanner').classList.add('active');document.querySelectorAll('.pcard').forEach(c=>c.draggable=true);document.getElementById('grid').classList.add('reorder-mode');}
function exitReorder(){reorderMode=false;document.getElementById('rbanner').classList.remove('active');document.querySelectorAll('.pcard').forEach(c=>c.draggable=false);document.getElementById('grid').classList.remove('reorder-mode');}

// â”€â”€ Rename â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openRen(idx){renIdx=idx;document.getElementById('ren-inp').value=cfg.buckets[idx].label;document.getElementById('ren-modal').classList.add('open');setTimeout(()=>document.getElementById('ren-inp').select(),60);}
function closeRen(){document.getElementById('ren-modal').classList.remove('open');renIdx=-1;}
async function confirmRen(){const n=document.getElementById('ren-inp').value.trim();if(!n||renIdx<0){closeRen();return;}cfg.buckets[renIdx].label=n;closeRen();await saveConfig('Rename: '+n);}
document.getElementById('ren-inp').addEventListener('keydown',e=>{if(e.key==='Enter')confirmRen();if(e.key==='Escape')closeRen();});

// â”€â”€ Add / Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAdd(){document.getElementById('add-modal').classList.add('open');setTimeout(()=>document.getElementById('nb-lbl').focus(),50);}
function closeAdd(){document.getElementById('add-modal').classList.remove('open');['nb-lbl','nb-ret','nb-url'].forEach(id=>document.getElementById(id).value='');}
async function confirmAdd(){
  const l=document.getElementById('nb-lbl').value.trim(),rn=document.getElementById('nb-ret').value.trim(),ru=document.getElementById('nb-url').value.trim();
  if(!l||!rn||!ru){alert('Please fill in all fields.');return;}
  cfg.buckets.push({label:l,retailers:[{name:rn,url:ru}]});closeAdd();await saveConfig('Add: '+l);
}
function toggleAddR(btn){btn.nextElementSibling?.classList.toggle('open');}
async function addRet(btn,idx){
  const form=btn.closest('.addr-form');
  const n=form.querySelector('.rn').value.trim(),u=form.querySelector('.ru').value.trim();
  if(!n||!u){alert('Enter retailer name and URL.');return;}
  cfg.buckets[idx].retailers.push({name:n,url:u});await saveConfig('Add retailer '+n);
}
function delBucket(idx){showConf('Delete Product?',`Remove "${cfg.buckets[idx].label}"? Historical data is kept.`,async()=>{cfg.buckets.splice(idx,1);await saveConfig('Delete product');});}

// â”€â”€ Pause â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPause(){document.getElementById('pau-modal').classList.add('open');}
function closePause(){document.getElementById('pau-modal').classList.remove('open');}
async function toggleWF(enable){
  const t=getToken();if(!t){showToast('Token required.');return;}
  showToast(enable?'Resuming...':'Pausing...');
  try{const r=await fetch(`${API}/actions/workflows/price_tracker.yml/${enable?'enable':'disable'}`,{method:'PUT',headers:{Authorization:`token ${t}`,Accept:'application/vnd.github.v3+json'}});showToast(r.status===204?(enable?'Resumed âœ“':'Paused âœ“'):'Error â€” check token');}
  catch(e){showToast('Error: '+e.message);}
}

// â”€â”€ Save config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveConfig(msg){
  const t=getToken();if(!t){alert('Token required.');return;}
  showToast('Saving...');
  try{
    const sr=await fetch(`${API}/contents/config.json`,{headers:{Authorization:`token ${t}`,Accept:'application/vnd.github.v3+json'}});
    const sha=(await sr.json()).sha;
    const body={email:{sender_email:'',app_password:'',recipient_email:''},buckets:cfg.buckets};
    const content=btoa(unescape(encodeURIComponent(JSON.stringify(body,null,2))));
    const res=await fetch(`${API}/contents/config.json`,{method:'PUT',headers:{Authorization:`token ${t}`,Accept:'application/vnd.github.v3+json','Content-Type':'application/json'},body:JSON.stringify({message:msg,content,sha,branch:GHB})});
    if(!res.ok){const e=await res.json();throw new Error(e.message);}
    showToast('Saved âœ“');setTimeout(()=>render(),400);
  }catch(e){showToast('Error: '+e.message);}
}

// â”€â”€ Confirm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showConf(t,m,cb){document.getElementById('conf-title').textContent=t;document.getElementById('conf-msg').textContent=m;confCb=cb;document.getElementById('conf-modal').classList.add('open');}
function closeConf(){document.getElementById('conf-modal').classList.remove('open');confCb=null;}
document.getElementById('conf-btn').onclick=async()=>{closeConf();if(confCb)await confCb();};

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('on');setTimeout(()=>t.classList.remove('on'),2500);}

// â”€â”€ Drag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initDrag(){
  const grid=document.getElementById('grid');let src=null;
  grid.querySelectorAll('.pcard').forEach(card=>{
    card.addEventListener('dragstart',e=>{if(!reorderMode)return;src=card;setTimeout(()=>card.classList.add('dragging'),0);e.dataTransfer.effectAllowed='move';});
    card.addEventListener('dragend',()=>{card.classList.remove('dragging');grid.querySelectorAll('.pcard').forEach(c=>c.classList.remove('drag-over'));if(!reorderMode)return;reorderSave(grid);});
    card.addEventListener('dragover',e=>{if(!reorderMode)return;e.preventDefault();if(card!==src){grid.querySelectorAll('.pcard').forEach(c=>c.classList.remove('drag-over'));card.classList.add('drag-over');}});
    card.addEventListener('drop',e=>{if(!reorderMode)return;e.preventDefault();if(card!==src){const cs=[...grid.querySelectorAll('.pcard')];cs.indexOf(src)<cs.indexOf(card)?card.after(src):card.before(src);}card.classList.remove('drag-over');});
  });
  let td=null,tc=null,tox=0,toy=0;
  grid.querySelectorAll('.dhandle').forEach(h=>{
    h.addEventListener('touchstart',e=>{if(!reorderMode)return;td=h.closest('.pcard');const r=td.getBoundingClientRect();tox=e.touches[0].clientX-r.left;toy=e.touches[0].clientY-r.top;tc=td.cloneNode(true);tc.style.cssText=`position:fixed;width:${r.width}px;opacity:.8;pointer-events:none;z-index:999;border-radius:12px;left:${r.left}px;top:${r.top}px`;document.body.appendChild(tc);td.style.opacity='.3';e.preventDefault();},{passive:false});
    h.addEventListener('touchmove',e=>{if(!td||!tc)return;const t=e.touches[0];tc.style.left=(t.clientX-tox)+'px';tc.style.top=(t.clientY-toy)+'px';const target=document.elementsFromPoint(t.clientX,t.clientY).find(el=>el.classList.contains('pcard')&&el!==td);grid.querySelectorAll('.pcard').forEach(c=>c.classList.remove('drag-over'));if(target)target.classList.add('drag-over');e.preventDefault();},{passive:false});
    h.addEventListener('touchend',e=>{if(!td)return;const t=e.changedTouches[0];const target=document.elementsFromPoint(t.clientX,t.clientY).find(el=>el.classList.contains('pcard')&&el!==td);if(target){const cs=[...grid.querySelectorAll('.pcard')];cs.indexOf(td)<cs.indexOf(target)?target.after(td):target.before(td);}td.style.opacity='';tc.remove();tc=null;td=null;grid.querySelectorAll('.pcard').forEach(c=>c.classList.remove('drag-over'));reorderSave(grid);});
  });
}
function reorderSave(grid){const order=[...grid.querySelectorAll('.pcard')].map(c=>parseInt(c.dataset.idx));cfg.buckets=order.map(i=>cfg.buckets[i]);grid.querySelectorAll('.pcard').forEach((c,i)=>c.dataset.idx=i);saveConfig('Reorder products');}

// â”€â”€ Chart â€” fixed x-axis with full date range â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function chartData(bucket,tf){
  const br=rows.filter(r=>bucket.retailers.some(ret=>r.name===`${bucket.label} - ${ret.name}`));
  if(!br.length)return{labels:[],prices:[],meta:[],sparse:false};

  // Generate full date range for timeframe
  const now=new Date();
  let startDate,endDate=new Date(now);
  endDate.setHours(23,59,59,999);

  if(tf==='all'){
    // For 'all', use actual data range
    const minTs=Math.min(...br.map(r=>r.ts));
    startDate=new Date(minTs);startDate.setHours(0,0,0,0);
  } else {
    const days=tf==='7d'?7:tf==='14d'?14:30;
    startDate=new Date(now);startDate.setDate(startDate.getDate()-(days-1));startDate.setHours(0,0,0,0);
  }

  // Build data lookup by date
  const byDay={};
  br.filter(r=>r.ts>=startDate&&r.ts<=endDate).forEach(r=>{
    const d=r.ts.toISOString().slice(0,10);
    if(!byDay[d])byDay[d]=[];byDay[d].push(r);
  });

  // Generate every day in range
  const labels=[],prices=[],meta=[],hasData=[];
  const cur=new Date(startDate);
  while(cur<=endDate){
    const d=cur.toISOString().slice(0,10);
    labels.push(d);
    if(byDay[d]){
      const min=Math.min(...byDay[d].filter(r=>!r.oos).map(r=>r.price).filter(p=>!isNaN(p)));
      if(isFinite(min)){
        const who=[...new Set(byDay[d].filter(r=>r.price===min&&!r.oos).map(r=>r.name.split(' - ').slice(1).join(' - ')))];
        prices.push(min);meta.push({price:min,names:who});hasData.push(true);
      } else {prices.push(null);meta.push(null);hasData.push(false);}
    } else {prices.push(null);meta.push(null);hasData.push(false);}
    cur.setDate(cur.getDate()+1);
  }
  return{labels,prices,meta,hasData};
}

function drawChart(bucket,idx,tf){
  // Must get canvas and check width FIRST â€” if card is collapsed clientWidth=0
  const canvas=document.getElementById('chart-'+idx);if(!canvas)return;
  const wrap=canvas.parentElement;
  if(!wrap||wrap.clientWidth<10){setTimeout(()=>drawChart(bucket,idx,tf),120);return;}
  const{labels,prices,meta,hasData}=chartData(bucket,tf);
  const ctx=canvas.getContext('2d');
  const tip=document.getElementById('ctip');
  if(charts[idx]){try{charts[idx].destroy();}catch(e){}delete charts[idx];}
  if(!labels.length){wrap.innerHTML='<div class="nodata">No data available</div>';return;}

  const dpr=window.devicePixelRatio||1,W=wrap.clientWidth,H=wrap.clientHeight||140;
  canvas.width=W*dpr;canvas.height=H*dpr;ctx.scale(dpr,dpr);

  const pad={top:10,right:12,bottom:26,left:52};
  const cW=W-pad.left-pad.right,cH=H-pad.top-pad.bottom;

  // Price range from actual data only
  const dataPoints=prices.filter(p=>p!==null);
  if(!dataPoints.length){wrap.innerHTML='<div class="nodata">No data for this timeframe</div>';return;}
  const minP=Math.min(...dataPoints)*0.986,maxP=Math.max(...dataPoints)*1.014,range=maxP-minP||1;

  // X position: evenly spaced across full date range
  const xPos=i=>pad.left+(labels.length>1?(i/(labels.length-1))*cW:cW/2);
  const yPos=p=>pad.top+cH-((p-minP)/range)*cH;

  // Grid lines
  ctx.strokeStyle='#2e3347';ctx.lineWidth=1;
  [0,.33,.66,1].forEach(t=>{
    const y=pad.top+t*cH;ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(pad.left+cW,y);ctx.stroke();
    ctx.fillStyle='#8a92b0';ctx.font='8px DM Mono,monospace';ctx.textAlign='right';
    ctx.fillText('$'+(maxP-t*range).toFixed(0),pad.left-4,y+3);
  });

  // Draw filled segments between consecutive data points
  const segments=[];let seg=null;
  prices.forEach((p,i)=>{
    if(p!==null){if(!seg){seg={start:i,pts:[]}}seg.pts.push({i,p});}
    else{if(seg){segments.push(seg);seg=null;}}
  });
  if(seg)segments.push(seg);

  segments.forEach(s=>{
    if(s.pts.length<2)return;
    const grad=ctx.createLinearGradient(0,pad.top,0,pad.top+cH);
    grad.addColorStop(0,'rgba(79,142,247,.18)');grad.addColorStop(1,'rgba(79,142,247,0)');
    ctx.beginPath();ctx.moveTo(xPos(s.pts[0].i),yPos(s.pts[0].p));
    s.pts.forEach(({i,p},j)=>{if(j>0)ctx.lineTo(xPos(i),yPos(p));});
    ctx.lineTo(xPos(s.pts[s.pts.length-1].i),pad.top+cH);ctx.lineTo(xPos(s.pts[0].i),pad.top+cH);
    ctx.closePath();ctx.fillStyle=grad;ctx.fill();
    ctx.beginPath();ctx.strokeStyle='#4f8ef7';ctx.lineWidth=2;ctx.lineJoin='round';
    s.pts.forEach(({i,p},j)=>{j===0?ctx.moveTo(xPos(i),yPos(p)):ctx.lineTo(xPos(i),yPos(p));});
    ctx.stroke();
  });

  // Dots on data points only
  prices.forEach((p,i)=>{
    if(p===null)return;
    ctx.beginPath();ctx.arc(xPos(i),yPos(p),2.5,0,Math.PI*2);
    ctx.fillStyle='#4f8ef7';ctx.fill();ctx.strokeStyle='#0f1117';ctx.lineWidth=1.5;ctx.stroke();
  });

  // X axis labels â€” show first, last, and evenly spaced
  ctx.fillStyle='#8a92b0';ctx.font='8px DM Mono,monospace';ctx.textAlign='center';
  const maxLbls=Math.max(2,Math.floor(cW/55));
  const step=Math.max(1,Math.floor((labels.length-1)/(maxLbls-1)));
  const show=new Set([0,labels.length-1]);
  for(let i=step;i<labels.length-1;i+=step)show.add(i);
  show.forEach(i=>{
    const d=new Date(labels[i]+'T12:00:00Z');
    ctx.fillText(d.toLocaleDateString('en-US',{month:'short',day:'numeric'}),xPos(i),H-4);
  });

  charts[idx]={labels,prices,meta,xPos,yPos,destroy:()=>{}};

  canvas.onmousemove=e=>{
    const rect=canvas.getBoundingClientRect(),mx=e.clientX-rect.left;
    const c=charts[idx];if(!c)return;
    let near=0,md=Infinity;
    c.labels.forEach((_,i)=>{const d=Math.abs(c.xPos(i)-mx);if(d<md){md=d;near=i;}});
    if(md>40||!c.meta[near]){tip.classList.remove('on');return;}
    const m=c.meta[near],date=new Date(c.labels[near]+'T12:00:00Z');
    tip.innerHTML=`<div class="ctip-date">${date.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'})}</div><div class="ctip-price">$${m.price.toFixed(2)}</div><div class="ctip-store">Lowest at: ${m.names.join(', ')}</div>`;
    tip.classList.add('on');
    const tx=e.clientX+12;tip.style.left=(tx+155>window.innerWidth?e.clientX-162:tx)+'px';tip.style.top=(e.clientY-14)+'px';
  };
  canvas.onmouseleave=()=>tip.classList.remove('on');
}

function changeTf(btn,idx,tf){
  btn.closest('.tfbtns').querySelectorAll('.tfbtn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
  const wrap=document.getElementById('chart-'+idx)?.parentElement;
  if(wrap){wrap.innerHTML=`<canvas id="chart-${idx}"></canvas>`;}
  drawChart(cfg.buckets[idx],idx,tf);
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadData();
window.addEventListener('resize',()=>{if(!cfg)return;cfg.buckets.forEach((b,i)=>{if(cState[i]!==false)drawChart(b,i,getTf(i));});});
</script>
</body>
</html>
