<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Price Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:#0f1117; --surface:#1a1d27; --surface2:#22263a; --border:#2e3347;
      --text:#e8eaf0; --muted:#7b82a0; --accent:#4f8ef7; --green:#34d98b;
      --red:#f75c5c; --yellow:#f7c948; --font-body:'DM Sans',sans-serif; --font-mono:'DM Mono',monospace; --radius:12px;
    }
    body { background:var(--bg); color:var(--text); font-family:var(--font-body); min-height:100vh; }
    header { padding:20px 32px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px; position:sticky; top:0; background:var(--bg); z-index:100; }
    .header-left h1 { font-size:1.2rem; font-weight:600; }
    .header-left h1 span { color:var(--accent); }
    .header-meta { font-size:0.72rem; color:var(--muted); font-family:var(--font-mono); margin-top:3px; }
    .header-right { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .status-dot { width:8px; height:8px; border-radius:50%; background:var(--green); animation:pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
    .status-text { font-size:0.72rem; color:var(--muted); font-family:var(--font-mono); }
    .btn { padding:7px 14px; border-radius:8px; font-size:0.8rem; cursor:pointer; font-family:var(--font-body); border:1px solid var(--border); transition:all 0.15s; }
    .btn-secondary { background:var(--surface2); color:var(--text); }
    .btn-secondary:hover { background:var(--surface); border-color:var(--accent); }
    .btn-primary { background:var(--accent); color:white; border-color:var(--accent); }
    .btn-primary:hover { background:#3a7ae0; }
    .btn-danger { background:rgba(247,92,92,0.15); color:var(--red); border-color:rgba(247,92,92,0.3); }
    .btn-danger:hover { background:rgba(247,92,92,0.25); }
    main { max-width:1100px; margin:0 auto; padding:28px 24px; }
    #loading,#error-state { text-align:center; padding:80px 20px; color:var(--muted); font-family:var(--font-mono); font-size:0.85rem; }
    #error-state { color:var(--red); }
    .products-grid { display:grid; gap:16px; }
    .product-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; animation:fadeUp 0.4s ease both; transition:border-color 0.15s; }
    .product-card.dragging { opacity:0.5; border-color:var(--accent); }
    .product-card.drag-over { border-color:var(--accent); border-style:dashed; }
    @keyframes fadeUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
    .card-header { padding:16px 20px; display:flex; align-items:center; gap:12px; cursor:pointer; user-select:none; transition:background 0.15s; }
    .card-header:hover { background:rgba(255,255,255,0.02); }
    .drag-handle { color:var(--muted); cursor:grab; padding:4px; border-radius:4px; flex-shrink:0; transition:color 0.15s; display:flex; flex-direction:column; gap:3px; }
    .drag-handle:active { cursor:grabbing; }
    .drag-handle:hover { color:var(--text); }
    .drag-handle span { display:block; width:16px; height:2px; background:currentColor; border-radius:2px; }
    .product-image { width:56px; height:56px; border-radius:8px; object-fit:cover; background:var(--surface2); flex-shrink:0; border:1px solid var(--border); }
    .product-image-placeholder { width:56px; height:56px; border-radius:8px; background:var(--surface2); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:1.2rem; flex-shrink:0; }
    .card-header-info { flex:1; min-width:0; }
    .product-name { font-size:0.95rem; font-weight:600; letter-spacing:-0.2px; }
    .product-sub { display:flex; align-items:center; gap:6px; margin-top:3px; flex-wrap:wrap; }
    .product-retailer-count { font-size:0.7rem; color:var(--muted); font-family:var(--font-mono); }
    .badge-deal { font-size:0.62rem; padding:2px 7px; border-radius:20px; font-family:var(--font-mono); background:rgba(52,217,139,0.15); color:var(--green); border:1px solid rgba(52,217,139,0.3); }
    .badge-warning { font-size:0.7rem; color:var(--yellow); }
    .card-header-right { display:flex; align-items:center; gap:10px; flex-shrink:0; }
    .best-price-compact { text-align:right; }
    .best-price-label { font-size:0.6rem; text-transform:uppercase; letter-spacing:1px; color:var(--muted); }
    .best-price-value { font-size:1.3rem; font-weight:600; font-family:var(--font-mono); color:var(--green); line-height:1.1; }
    .best-price-value.no-price { color:var(--muted); font-size:0.9rem; }
    .btn-icon { width:28px; height:28px; border-radius:6px; border:1px solid var(--border); background:var(--surface2); color:var(--muted); font-size:0.8rem; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.15s; flex-shrink:0; }
    .btn-icon:hover { border-color:var(--accent); color:var(--text); }
    .btn-icon.danger:hover { border-color:var(--red); color:var(--red); background:rgba(247,92,92,0.1); }
    .collapse-arrow { color:var(--muted); font-size:0.7rem; transition:transform 0.2s; flex-shrink:0; }
    .collapse-arrow.open { transform:rotate(180deg); }
    .card-body { overflow:hidden; transition:max-height 0.3s ease; max-height:2000px; border-top:1px solid var(--border); }
    .card-body.collapsed { max-height:0; border-top:none; }
    .retailers { padding:12px 20px; border-bottom:1px solid var(--border); display:flex; flex-direction:column; gap:6px; }
    .retailer-row { display:flex; align-items:center; justify-content:space-between; padding:8px 12px; border-radius:8px; background:var(--surface2); }
    .retailer-row.is-best { border-left:3px solid var(--green); }
    .retailer-row.is-failed { opacity:0.5; }
    .retailer-info { display:flex; align-items:center; gap:8px; }
    .retailer-name a { color:var(--text); text-decoration:none; font-size:0.85rem; }
    .retailer-name a:hover { color:var(--accent); }
    .tag { font-size:0.6rem; padding:2px 7px; border-radius:20px; font-family:var(--font-mono); text-transform:uppercase; letter-spacing:0.5px; }
    .tag-best { background:rgba(52,217,139,0.15); color:var(--green); border:1px solid rgba(52,217,139,0.3); }
    .tag-failed { background:rgba(247,92,92,0.15); color:var(--red); border:1px solid rgba(247,92,92,0.3); }
    .retailer-price { font-family:var(--font-mono); font-size:0.88rem; font-weight:500; }
    .retailer-price.is-best { color:var(--green); }
    .retailer-price.is-unavailable { color:var(--muted); font-style:italic; font-size:0.78rem; }
    .add-retailer-row { padding:10px 20px 16px; }
    .add-retailer-form { display:none; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .add-retailer-form.open { display:flex; }
    .add-retailer-form input { flex:1; min-width:140px; padding:7px 12px; border-radius:8px; border:1px solid var(--border); background:var(--surface2); color:var(--text); font-size:0.82rem; font-family:var(--font-body); outline:none; }
    .add-retailer-form input:focus { border-color:var(--accent); }
    .btn-add-retailer { font-size:0.75rem; color:var(--muted); background:none; border:1px dashed var(--border); border-radius:8px; padding:6px 12px; cursor:pointer; transition:all 0.15s; }
    .btn-add-retailer:hover { border-color:var(--accent); color:var(--accent); }
    .graph-section { padding:16px 20px 20px; }
    .graph-controls { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap; gap:8px; }
    .graph-title { font-size:0.72rem; color:var(--muted); text-transform:uppercase; letter-spacing:1px; }
    .timeframe-btns { display:flex; gap:4px; }
    .tf-btn { padding:4px 10px; border-radius:6px; border:1px solid var(--border); background:transparent; color:var(--muted); font-size:0.7rem; cursor:pointer; font-family:var(--font-mono); transition:all 0.15s; }
    .tf-btn:hover { border-color:var(--accent); color:var(--text); }
    .tf-btn.active { background:var(--accent); border-color:var(--accent); color:white; }
    .graph-wrap { position:relative; height:150px; }
    canvas { width:100% !important; }
    .no-data { display:flex; align-items:center; justify-content:center; height:100%; color:var(--muted); font-size:0.78rem; font-family:var(--font-mono); }
    .chart-tooltip { position:fixed; background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:10px 14px; font-size:0.78rem; pointer-events:none; opacity:0; transition:opacity 0.15s; z-index:1000; min-width:160px; box-shadow:0 8px 24px rgba(0,0,0,0.4); }
    .chart-tooltip.visible { opacity:1; }
    .tooltip-date { font-family:var(--font-mono); font-size:0.68rem; color:var(--muted); margin-bottom:6px; }
    .tooltip-price { font-family:var(--font-mono); font-size:1rem; font-weight:500; color:var(--green); margin-bottom:4px; }
    .tooltip-retailers { font-size:0.7rem; color:var(--muted); line-height:1.5; }
    .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:200; align-items:center; justify-content:center; padding:20px; }
    .modal-overlay.open { display:flex; }
    .modal { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:28px; width:100%; max-width:480px; }
    .modal h2 { font-size:1rem; margin-bottom:20px; }
    .modal label { display:block; font-size:0.78rem; color:var(--muted); margin-bottom:5px; margin-top:14px; }
    .modal input { width:100%; padding:9px 12px; border-radius:8px; border:1px solid var(--border); background:var(--surface2); color:var(--text); font-size:0.85rem; font-family:var(--font-body); outline:none; }
    .modal input:focus { border-color:var(--accent); }
    .modal-actions { display:flex; justify-content:flex-end; gap:8px; margin-top:24px; }
    .confirm-modal { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:24px; width:100%; max-width:380px; }
    .confirm-modal p { font-size:0.88rem; color:var(--muted); margin-top:8px; line-height:1.5; }
    .confirm-modal-actions { display:flex; justify-content:flex-end; gap:8px; margin-top:20px; }
    .saving-toast { position:fixed; bottom:20px; right:20px; background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:10px 16px; font-size:0.8rem; font-family:var(--font-mono); color:var(--muted); opacity:0; transition:opacity 0.2s; z-index:300; }
    .saving-toast.visible { opacity:1; }
    @media (max-width:600px) { header{padding:14px 16px} main{padding:16px} .best-price-value{font-size:1.1rem} .graph-wrap{height:120px} }
  </style>
</head>
<body>
<header>
  <div class="header-left">
    <h1>Price <span>Tracker</span></h1>
    <div class="header-meta" id="last-updated">Loading...</div>
  </div>
  <div class="header-right">
    <div class="status-dot"></div>
    <span class="status-text">Live</span>
    <button class="btn btn-secondary" onclick="toggleAll(true)">Expand All</button>
    <button class="btn btn-secondary" onclick="toggleAll(false)">Collapse All</button>
    <button class="btn btn-secondary" onclick="loadData()">‚Üª Refresh</button>
    <button class="btn btn-primary" onclick="openAddBucket()">+ Add Product</button>
  </div>
</header>
<main>
  <div id="loading">Fetching price data...</div>
  <div id="error-state" style="display:none"></div>
  <div id="products-grid" class="products-grid" style="display:none"></div>
</main>
<div class="modal-overlay" id="add-bucket-modal">
  <div class="modal">
    <h2>Add New Product</h2>
    <label>Product Name</label>
    <input id="new-bucket-label" type="text" placeholder="e.g. Breville Barista Express" />
    <label>First Retailer Name</label>
    <input id="new-retailer-name" type="text" placeholder="e.g. Amazon" />
    <label>Product URL</label>
    <input id="new-retailer-url" type="url" placeholder="https://..." />
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeAddBucket()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmAddBucket()">Add Product</button>
    </div>
  </div>
</div>
<div class="modal-overlay" id="confirm-modal">
  <div class="confirm-modal">
    <h2 id="confirm-title">Are you sure?</h2>
    <p id="confirm-message"></p>
    <div class="confirm-modal-actions">
      <button class="btn btn-secondary" onclick="closeConfirm()">Cancel</button>
      <button class="btn btn-danger" id="confirm-action-btn">Delete</button>
    </div>
  </div>
</div>
<div class="chart-tooltip" id="tooltip"></div>
<div class="saving-toast" id="saving-toast">Saving...</div>
<script>
const GITHUB_USER='Hafoozi',GITHUB_REPO='price-tracker',GITHUB_BRANCH='main';
const CSV_URL=`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/price_history.csv`;
const CONFIG_URL=`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/config.json`;
const API_BASE=`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}`;
let GH_TOKEN=localStorage.getItem('gh_token')||'';
let allRows=[],config=null,charts={},confirmCallback=null,collapseState={};

function getToken(){if(!GH_TOKEN){GH_TOKEN=prompt('Enter your GitHub Personal Access Token:');if(GH_TOKEN)localStorage.setItem('gh_token',GH_TOKEN);}return GH_TOKEN;}

async function loadData(){
  document.getElementById('loading').style.display='block';
  document.getElementById('error-state').style.display='none';
  document.getElementById('products-grid').style.display='none';
  try{
    const[csvRes,cfgRes]=await Promise.all([fetch(CSV_URL+'?t='+Date.now()),fetch(CONFIG_URL+'?t='+Date.now())]);
    if(!csvRes.ok)throw new Error('CSV '+csvRes.status);
    if(!cfgRes.ok)throw new Error('Config '+cfgRes.status);
    const csvText=await csvRes.text();
    config=await cfgRes.json();
    const parsed=Papa.parse(csvText,{header:true,skipEmptyLines:true});
    allRows=parsed.data.map(r=>({timestamp:new Date(r.timestamp),name:r.name.trim(),price:parseFloat(r.price),url:r.url.trim(),image:(r.image||'').trim()})).filter(r=>!isNaN(r.price));
    const lastTs=new Date(Math.max(...allRows.map(r=>r.timestamp)));
    document.getElementById('last-updated').textContent='Last updated: '+lastTs.toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'});
    renderDashboard();
  }catch(e){
    document.getElementById('loading').style.display='none';
    const el=document.getElementById('error-state');el.style.display='block';el.textContent='‚ö† '+e.message;
  }
}

function renderDashboard(){
  const grid=document.getElementById('products-grid');
  grid.innerHTML='';
  Object.values(charts).forEach(c=>c&&c.destroy&&c.destroy());
  charts={};
  config.buckets.forEach((bucket,idx)=>{
    const isOpen=collapseState[idx]!==false;
    grid.appendChild(buildCard(bucket,idx,isOpen));
  });
  document.getElementById('loading').style.display='none';
  grid.style.display='grid';
  config.buckets.forEach((bucket,idx)=>{if(collapseState[idx]!==false)drawChart(bucket,idx,'all');});
  initDragAndDrop();
}

function getRetailerData(bucket){
  return bucket.retailers.map(r=>{
    const name=`${bucket.label} - ${r.name}`;
    const rows=allRows.filter(row=>row.name===name);
    const latest=rows.length?rows.reduce((a,b)=>a.timestamp>b.timestamp?a:b):null;
    return{name:r.name,url:r.url,price:latest?.price??null,image:latest?.image??'',failed:!latest};
  });
}

function getHistoricalAverage(bucket){
  const rows=allRows.filter(r=>bucket.retailers.some(ret=>r.name===`${bucket.label} - ${ret.name}`));
  if(!rows.length)return null;
  const byDate={};
  rows.forEach(r=>{const d=r.timestamp.toISOString().slice(0,10);if(!byDate[d])byDate[d]=[];byDate[d].push(r.price);});
  const lows=Object.values(byDate).map(p=>Math.min(...p));
  return lows.reduce((a,b)=>a+b,0)/lows.length;
}

function buildCard(bucket,idx,isOpen){
  const retailers=getRetailerData(bucket);
  const prices=retailers.filter(r=>r.price!==null).map(r=>r.price);
  const bestPrice=prices.length?Math.min(...prices):null;
  const hasWarning=retailers.some(r=>r.failed);
  const image=retailers.find(r=>r.image)?.image||'';
  const avg=getHistoricalAverage(bucket);
  const isDeal=bestPrice!==null&&avg!==null&&bestPrice<avg;
  const dealPct=isDeal?((avg-bestPrice)/avg*100).toFixed(1):null;

  const card=document.createElement('div');
  card.className='product-card';card.dataset.idx=idx;card.draggable=true;
  card.style.animationDelay=(idx*0.06)+'s';

  const imgHtml=image
    ?`<img class="product-image" src="${image}" alt="${bucket.label}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"/><div class="product-image-placeholder" style="display:none">üõç</div>`
    :`<div class="product-image-placeholder">üõç</div>`;

  const header=document.createElement('div');
  header.className='card-header';
  header.innerHTML=`
    <div class="drag-handle" title="Drag to reorder" onclick="event.stopPropagation()"><span></span><span></span><span></span></div>
    ${imgHtml}
    <div class="card-header-info">
      <div class="product-name">${bucket.label}</div>
      <div class="product-sub">
        <span class="product-retailer-count">${retailers.length} retailer${retailers.length!==1?'s':''}</span>
        ${isDeal?`<span class="badge-deal">‚Üì ${dealPct}% below avg</span>`:''}
        ${hasWarning?`<span class="badge-warning" title="Some retailers have no data">‚ö†</span>`:''}
      </div>
    </div>
    <div class="card-header-right">
      <div class="best-price-compact">
        <div class="best-price-label">Lowest</div>
        <div class="best-price-value ${bestPrice===null?'no-price':''}">${bestPrice!==null?'$'+bestPrice.toFixed(2):'‚Äî'}</div>
      </div>
      <button class="btn-icon danger" title="Delete" onclick="event.stopPropagation();deleteBucket(${idx})">‚úï</button>
      <div class="collapse-arrow ${isOpen?'open':''}">‚ñº</div>
    </div>`;
  header.addEventListener('click',()=>toggleCard(idx));

  const body=document.createElement('div');
  body.className='card-body'+(isOpen?'':' collapsed');

  const retailersEl=document.createElement('div');
  retailersEl.className='retailers';
  retailers.forEach((r,rIdx)=>{
    const isBest=r.price!==null&&r.price===bestPrice;
    const row=document.createElement('div');
    row.className='retailer-row'+(isBest?' is-best':'')+(r.failed?' is-failed':'');
    row.innerHTML=`
      <div class="retailer-info">
        <div class="retailer-name"><a href="${r.url}" target="_blank">${r.name}</a></div>
        ${isBest?'<span class="tag tag-best">Best</span>':''}
        ${r.failed?'<span class="tag tag-failed">No Data</span>':''}
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="retailer-price ${isBest?'is-best':''} ${r.price===null?'is-unavailable':''}">${r.price!==null?'$'+r.price.toFixed(2):'unavailable'}</div>
        <button class="btn-icon danger" title="Remove" onclick="deleteRetailer(${idx},${rIdx})" style="width:22px;height:22px;font-size:0.65rem">‚úï</button>
      </div>`;
    retailersEl.appendChild(row);
  });

  const addRow=document.createElement('div');
  addRow.className='add-retailer-row';
  addRow.innerHTML=`
    <button class="btn-add-retailer" onclick="toggleAddRetailer(this)">+ Add retailer</button>
    <div class="add-retailer-form">
      <input type="text" placeholder="Retailer name" class="retailer-name-input"/>
      <input type="url" placeholder="Product URL" class="retailer-url-input"/>
      <button class="btn btn-primary" style="font-size:0.78rem;padding:6px 12px" onclick="confirmAddRetailer(this,${idx})">Add</button>
      <button class="btn btn-secondary" style="font-size:0.78rem;padding:6px 12px" onclick="toggleAddRetailer(this.parentElement.previousElementSibling)">Cancel</button>
    </div>`;

  const graphSection=document.createElement('div');
  graphSection.className='graph-section';
  graphSection.innerHTML=`
    <div class="graph-controls">
      <div class="graph-title">Price History ‚Äî Lowest Daily Price</div>
      <div class="timeframe-btns">
        <button class="tf-btn active" onclick="changeTimeframe(this,${idx},'all')">All</button>
        <button class="tf-btn" onclick="changeTimeframe(this,${idx},'30d')">30D</button>
        <button class="tf-btn" onclick="changeTimeframe(this,${idx},'14d')">14D</button>
        <button class="tf-btn" onclick="changeTimeframe(this,${idx},'7d')">7D</button>
      </div>
    </div>
    <div class="graph-wrap"><canvas id="chart-${idx}"></canvas></div>`;

  body.appendChild(retailersEl);body.appendChild(addRow);body.appendChild(graphSection);
  card.appendChild(header);card.appendChild(body);
  return card;
}

function toggleCard(idx){
  const card=document.querySelector(`.product-card[data-idx="${idx}"]`);if(!card)return;
  const body=card.querySelector('.card-body');
  const arrow=card.querySelector('.collapse-arrow');
  const isOpen=!body.classList.contains('collapsed');
  if(isOpen){body.classList.add('collapsed');arrow.classList.remove('open');collapseState[idx]=false;}
  else{body.classList.remove('collapsed');arrow.classList.add('open');collapseState[idx]=true;setTimeout(()=>drawChart(config.buckets[idx],idx,getCurrentTf(idx)),50);}
}

function toggleAll(open){
  config.buckets.forEach((_,idx)=>{
    const card=document.querySelector(`.product-card[data-idx="${idx}"]`);if(!card)return;
    const body=card.querySelector('.card-body');const arrow=card.querySelector('.collapse-arrow');
    if(open){body.classList.remove('collapsed');arrow.classList.add('open');collapseState[idx]=true;setTimeout(()=>drawChart(config.buckets[idx],idx,getCurrentTf(idx)),50);}
    else{body.classList.add('collapsed');arrow.classList.remove('open');collapseState[idx]=false;}
  });
}

function getCurrentTf(idx){return document.querySelector(`#chart-${idx}`)?.closest('.graph-section')?.querySelector('.tf-btn.active')?.textContent.toLowerCase()||'all';}

function initDragAndDrop(){
  const grid=document.getElementById('products-grid');
  let dragSrc=null;
  grid.querySelectorAll('.product-card').forEach(card=>{
    card.addEventListener('dragstart',e=>{dragSrc=card;setTimeout(()=>card.classList.add('dragging'),0);e.dataTransfer.effectAllowed='move';});
    card.addEventListener('dragend',()=>{
      card.classList.remove('dragging');
      grid.querySelectorAll('.product-card').forEach(c=>c.classList.remove('drag-over'));
      const newOrder=[...grid.querySelectorAll('.product-card')].map(c=>parseInt(c.dataset.idx));
      config.buckets=newOrder.map(i=>config.buckets[i]);
      grid.querySelectorAll('.product-card').forEach((c,i)=>c.dataset.idx=i);
      saveConfig('Reorder products');
    });
    card.addEventListener('dragover',e=>{e.preventDefault();if(card!==dragSrc){grid.querySelectorAll('.product-card').forEach(c=>c.classList.remove('drag-over'));card.classList.add('drag-over');}});
    card.addEventListener('drop',e=>{e.preventDefault();if(card!==dragSrc){const cards=[...grid.querySelectorAll('.product-card')];const si=cards.indexOf(dragSrc);const di=cards.indexOf(card);if(si<di)card.after(dragSrc);else card.before(dragSrc);}card.classList.remove('drag-over');});
  });

  let touchDrag=null,touchClone=null,touchOffX=0,touchOffY=0;
  grid.querySelectorAll('.drag-handle').forEach(handle=>{
    handle.addEventListener('touchstart',e=>{
      const card=handle.closest('.product-card');touchDrag=card;
      const rect=card.getBoundingClientRect();touchOffX=e.touches[0].clientX-rect.left;touchOffY=e.touches[0].clientY-rect.top;
      touchClone=card.cloneNode(true);touchClone.style.cssText=`position:fixed;width:${rect.width}px;opacity:0.8;pointer-events:none;z-index:999;border-radius:12px;`;
      document.body.appendChild(touchClone);card.style.opacity='0.3';e.preventDefault();
    },{passive:false});
    handle.addEventListener('touchmove',e=>{
      if(!touchDrag||!touchClone)return;const t=e.touches[0];
      touchClone.style.left=(t.clientX-touchOffX)+'px';touchClone.style.top=(t.clientY-touchOffY)+'px';
      const els=document.elementsFromPoint(t.clientX,t.clientY);
      const target=els.find(el=>el.classList.contains('product-card')&&el!==touchDrag);
      grid.querySelectorAll('.product-card').forEach(c=>c.classList.remove('drag-over'));
      if(target)target.classList.add('drag-over');e.preventDefault();
    },{passive:false});
    handle.addEventListener('touchend',e=>{
      if(!touchDrag)return;const t=e.changedTouches[0];
      const els=document.elementsFromPoint(t.clientX,t.clientY);
      const target=els.find(el=>el.classList.contains('product-card')&&el!==touchDrag);
      if(target){const cards=[...grid.querySelectorAll('.product-card')];const si=cards.indexOf(touchDrag);const di=cards.indexOf(target);if(si<di)target.after(touchDrag);else target.before(touchDrag);}
      touchDrag.style.opacity='';touchClone.remove();touchClone=null;touchDrag=null;
      grid.querySelectorAll('.product-card').forEach(c=>c.classList.remove('drag-over'));
      const newOrder=[...grid.querySelectorAll('.product-card')].map(c=>parseInt(c.dataset.idx));
      config.buckets=newOrder.map(i=>config.buckets[i]);
      grid.querySelectorAll('.product-card').forEach((c,i)=>c.dataset.idx=i);
      saveConfig('Reorder products');
    });
  });
}

function openAddBucket(){document.getElementById('add-bucket-modal').classList.add('open');document.getElementById('new-bucket-label').focus();}
function closeAddBucket(){document.getElementById('add-bucket-modal').classList.remove('open');['new-bucket-label','new-retailer-name','new-retailer-url'].forEach(id=>document.getElementById(id).value='');}
async function confirmAddBucket(){
  const label=document.getElementById('new-bucket-label').value.trim();
  const rName=document.getElementById('new-retailer-name').value.trim();
  const rUrl=document.getElementById('new-retailer-url').value.trim();
  if(!label||!rName||!rUrl){alert('Please fill in all fields.');return;}
  config.buckets.push({label,retailers:[{name:rName,url:rUrl}]});
  closeAddBucket();await saveConfig('Add product: '+label);
}
function toggleAddRetailer(btn){const form=btn.nextElementSibling;if(form)form.classList.toggle('open');}
async function confirmAddRetailer(btn,bucketIdx){
  const form=btn.closest('.add-retailer-form');
  const rName=form.querySelector('.retailer-name-input').value.trim();
  const rUrl=form.querySelector('.retailer-url-input').value.trim();
  if(!rName||!rUrl){alert('Please enter a retailer name and URL.');return;}
  config.buckets[bucketIdx].retailers.push({name:rName,url:rUrl});
  await saveConfig('Add retailer '+rName);
}
function deleteBucket(idx){showConfirm('Delete Product?',`Remove "${config.buckets[idx].label}" from tracking?`,async()=>{config.buckets.splice(idx,1);await saveConfig('Delete bucket');});}
function deleteRetailer(bucketIdx,rIdx){
  const r=config.buckets[bucketIdx].retailers[rIdx];
  showConfirm('Remove Retailer?',`Remove "${r.name}"?`,async()=>{config.buckets[bucketIdx].retailers.splice(rIdx,1);await saveConfig('Remove retailer '+r.name);});
}

async function saveConfig(msg){
  const token=getToken();if(!token){alert('Token required.');return;}
  showToast('Saving to GitHub...');
  try{
    const shaRes=await fetch(`${API_BASE}/contents/config.json`,{headers:{Authorization:`token ${token}`,Accept:'application/vnd.github.v3+json'}});
    const shaData=await shaRes.json();
    const ghConfig={email:{sender_email:'',app_password:'',recipient_email:''},buckets:config.buckets};
    const content=btoa(unescape(encodeURIComponent(JSON.stringify(ghConfig,null,2))));
    const res=await fetch(`${API_BASE}/contents/config.json`,{method:'PUT',headers:{Authorization:`token ${token}`,Accept:'application/vnd.github.v3+json','Content-Type':'application/json'},body:JSON.stringify({message:msg,content,sha:shaData.sha,branch:GITHUB_BRANCH})});
    if(!res.ok){const err=await res.json();throw new Error(err.message);}
    showToast('Saved ‚úì');setTimeout(()=>renderDashboard(),400);
  }catch(e){showToast('Error: '+e.message);}
}

function showConfirm(title,message,callback){document.getElementById('confirm-title').textContent=title;document.getElementById('confirm-message').textContent=message;confirmCallback=callback;document.getElementById('confirm-modal').classList.add('open');}
function closeConfirm(){document.getElementById('confirm-modal').classList.remove('open');confirmCallback=null;}
document.getElementById('confirm-action-btn').onclick=async()=>{closeConfirm();if(confirmCallback)await confirmCallback();};
function showToast(msg){const t=document.getElementById('saving-toast');t.textContent=msg;t.classList.add('visible');setTimeout(()=>t.classList.remove('visible'),2500);}

function getChartData(bucket,tf){
  const rows=allRows.filter(r=>bucket.retailers.some(ret=>r.name===`${bucket.label} - ${ret.name}`));
  if(!rows.length)return{labels:[],prices:[],retailers:[]};
  const days=tf==='7d'?7:tf==='14d'?14:tf==='30d'?30:null;
  const cutoff=days?new Date(Date.now()-days*86400000):null;
  const filtered=cutoff?rows.filter(r=>r.timestamp>=cutoff):rows;
  const byDate={};
  filtered.forEach(r=>{const d=r.timestamp.toISOString().slice(0,10);if(!byDate[d])byDate[d]=[];byDate[d].push(r);});
  const labels=[],prices=[],retailers=[];
  Object.keys(byDate).sort().forEach(date=>{
    const dr=byDate[date];const min=Math.min(...dr.map(r=>r.price));
    const w=[...new Set(dr.filter(r=>r.price===min).map(r=>r.name.split(' - ')[1]||r.name))];
    labels.push(date);prices.push(min);retailers.push({price:min,names:w});
  });
  return{labels,prices,retailers};
}

function drawChart(bucket,idx,tf){
  const{labels,prices,retailers}=getChartData(bucket,tf);
  const canvas=document.getElementById('chart-'+idx);if(!canvas)return;
  const ctx=canvas.getContext('2d');const tooltip=document.getElementById('tooltip');
  if(charts[idx]){try{charts[idx].destroy();}catch(e){}delete charts[idx];}
  const wrap=canvas.parentElement;
  if(!labels.length){wrap.innerHTML='<div class="no-data">No data for this timeframe</div>';return;}
  const dpr=window.devicePixelRatio||1,W=wrap.clientWidth,H=wrap.clientHeight||150;
  canvas.width=W*dpr;canvas.height=H*dpr;ctx.scale(dpr,dpr);
  const pad={top:10,right:14,bottom:28,left:52};
  const cW=W-pad.left-pad.right,cH=H-pad.top-pad.bottom;
  const minP=Math.min(...prices)*0.985,maxP=Math.max(...prices)*1.015,range=maxP-minP||1;
  const xPos=i=>pad.left+(labels.length>1?(i/(labels.length-1))*cW:cW/2);
  const yPos=p=>pad.top+cH-((p-minP)/range)*cH;
  ctx.strokeStyle='#2e3347';ctx.lineWidth=1;
  [0,.33,.66,1].forEach(t=>{const y=pad.top+t*cH;ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(pad.left+cW,y);ctx.stroke();ctx.fillStyle='#7b82a0';ctx.font='9px DM Mono,monospace';ctx.textAlign='right';ctx.fillText('$'+(maxP-t*range).toFixed(0),pad.left-5,y+3);});
  const grad=ctx.createLinearGradient(0,pad.top,0,pad.top+cH);grad.addColorStop(0,'rgba(79,142,247,0.22)');grad.addColorStop(1,'rgba(79,142,247,0)');
  ctx.beginPath();ctx.moveTo(xPos(0),yPos(prices[0]));prices.forEach((p,i)=>{if(i>0)ctx.lineTo(xPos(i),yPos(p));});ctx.lineTo(xPos(prices.length-1),pad.top+cH);ctx.lineTo(xPos(0),pad.top+cH);ctx.closePath();ctx.fillStyle=grad;ctx.fill();
  ctx.beginPath();ctx.strokeStyle='#4f8ef7';ctx.lineWidth=2;ctx.lineJoin='round';prices.forEach((p,i)=>i===0?ctx.moveTo(xPos(i),yPos(p)):ctx.lineTo(xPos(i),yPos(p)));ctx.stroke();
  prices.forEach((p,i)=>{ctx.beginPath();ctx.arc(xPos(i),yPos(p),3,0,Math.PI*2);ctx.fillStyle='#4f8ef7';ctx.fill();ctx.strokeStyle='#0f1117';ctx.lineWidth=1.5;ctx.stroke();});
  ctx.fillStyle='#7b82a0';ctx.font='9px DM Mono,monospace';ctx.textAlign='center';
  const step=Math.ceil(labels.length/5);
  labels.forEach((l,i)=>{if(i%step===0||i===labels.length-1){const d=new Date(l+'T12:00:00');ctx.fillText(d.toLocaleDateString('en-US',{month:'short',day:'numeric'}),xPos(i),H-6);}});
  charts[idx]={labels,prices,retailers,xPos,yPos,destroy:()=>{}};
  canvas.onmousemove=e=>{
    const rect=canvas.getBoundingClientRect();const mX=e.clientX-rect.left;const c=charts[idx];if(!c)return;
    let near=0,md=Infinity;c.labels.forEach((_,i)=>{const d=Math.abs(c.xPos(i)-mX);if(d<md){md=d;near=i;}});
    if(md>40){tooltip.classList.remove('visible');return;}
    const r=c.retailers[near];const date=new Date(c.labels[near]+'T12:00:00');
    tooltip.innerHTML=`<div class="tooltip-date">${date.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'})}</div><div class="tooltip-price">$${r.price.toFixed(2)}</div><div class="tooltip-retailers">Lowest at: ${r.names.join(', ')}</div>`;
    tooltip.classList.add('visible');const tx=e.clientX+14;tooltip.style.left=(tx+180>window.innerWidth?e.clientX-190:tx)+'px';tooltip.style.top=(e.clientY-20)+'px';
  };
  canvas.onmouseleave=()=>tooltip.classList.remove('visible');
}

function changeTimeframe(btn,idx,tf){
  btn.closest('.timeframe-btns').querySelectorAll('.tf-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
  const wrap=document.getElementById('chart-'+idx)?.parentElement;
  if(wrap&&!wrap.querySelector('canvas'))wrap.innerHTML=`<canvas id="chart-${idx}"></canvas>`;
  drawChart(config.buckets[idx],idx,tf);
}

loadData();
window.addEventListener('resize',()=>{if(!config)return;config.buckets.forEach((b,i)=>{if(collapseState[i]!==false)drawChart(b,i,getCurrentTf(i));});});
</script>
</body>
</html>
